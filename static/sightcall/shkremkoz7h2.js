function trace(a){if("\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),window.performance){var b=(window.performance.now()/1e3).toFixed(3);webrtcUtils.log(b+": "+a)}else webrtcUtils.log(a)}function requestUserMedia(a){return new Promise(function(b,c){getUserMedia(a,b,c)})}function onWeemoPluginLoaded(){sightcallPluginLoaded=!0}!function(window){delete Array.prototype.toJSON;var instance=0,Rtcc=function(){function arrayFilter(a,b){if(Array.prototype.filter)return a.filter(b);var c=(Object(this),a.length>>>0);if(c>a.length||"function"!=typeof b)throw new TypeError;for(var d=[],e=0;c>e;e++)if(e in a){var f=a[e];b.call(void 0,f,e,a)&&d.push(f)}return d}function b64ToUint6(a){return a>64&&91>a?a-65:a>96&&123>a?a-71:a>47&&58>a?a+4:43===a?62:47===a?63:0}function base64DecToArr(a,b){for(var c,d,e=a.replace(/[^A-Za-z0-9\+\/]/g,""),f=e.length,g=b?Math.ceil((3*f+1>>2)/b)*b:3*f+1>>2,h=new Uint8Array(g),i=0,j=0,k=0;f>k;k++)if(d=3&k,i|=b64ToUint6(e.charCodeAt(k))<<18-6*d,3===d||f-k===1){for(c=0;3>c&&g>j;c++,j++)h[j]=i>>>(16>>>c&24)&255;i=0}return h}function uint6ToB64(a){return 26>a?a+65:52>a?a+71:62>a?a-4:62===a?43:63===a?47:65}function base64EncArr(a){for(var b=2,c="",d=a.length,e=0,f=0;d>f;f++)b=f%3,e|=a[f]<<(16>>>b&24),(2===b||a.length-f===1)&&(c+=String.fromCharCode(uint6ToB64(e>>>18&63),uint6ToB64(e>>>12&63),uint6ToB64(e>>>6&63),uint6ToB64(63&e)),e=0);return c.substr(0,c.length-2+b)+(2===b?"":1===b?"=":"==")}function UTF8ArrToStr(a){for(var b,c="",d=a.length,e=0;d>e;e++)b=a[e],c+=String.fromCharCode(b>251&&254>b&&d>e+5?1073741824*(b-252)+(a[++e]-128<<24)+(a[++e]-128<<18)+(a[++e]-128<<12)+(a[++e]-128<<6)+a[++e]-128:b>247&&252>b&&d>e+4?(b-248<<24)+(a[++e]-128<<18)+(a[++e]-128<<12)+(a[++e]-128<<6)+a[++e]-128:b>239&&248>b&&d>e+3?(b-240<<18)+(a[++e]-128<<12)+(a[++e]-128<<6)+a[++e]-128:b>223&&240>b&&d>e+2?(b-224<<12)+(a[++e]-128<<6)+a[++e]-128:b>191&&224>b&&d>e+1?(b-192<<6)+a[++e]-128:b);return c}function strToUTF8Arr(a){for(var b,c,d=a.length,e=0,f=0;d>f;f++)c=a.charCodeAt(f),e+=128>c?1:2048>c?2:65536>c?3:2097152>c?4:67108864>c?5:6;b=new Uint8Array(e);for(var g=0,h=0;e>g;h++)c=a.charCodeAt(h),128>c?b[g++]=c:2048>c?(b[g++]=192+(c>>>6),b[g++]=128+(63&c)):65536>c?(b[g++]=224+(c>>>12),b[g++]=128+(c>>>6&63),b[g++]=128+(63&c)):2097152>c?(b[g++]=240+(c>>>18),b[g++]=128+(c>>>12&63),b[g++]=128+(c>>>6&63),b[g++]=128+(63&c)):67108864>c?(b[g++]=248+(c>>>24),b[g++]=128+(c>>>18&63),b[g++]=128+(c>>>12&63),b[g++]=128+(c>>>6&63),b[g++]=128+(63&c)):(b[g++]=252+c/1073741824,b[g++]=128+(c>>>24&63),b[g++]=128+(c>>>18&63),b[g++]=128+(c>>>12&63),b[g++]=128+(c>>>6&63),b[g++]=128+(63&c));return b}function clone(a){if(null===a||"object"!=typeof a)return a;var b;if(a instanceof Date)return b=new Date,b.setTime(a.getTime()),b;if(a instanceof Array){b=[];for(var c=0,d=a.length;d>c;c++)b[c]=clone(a[c]);return b}if(a instanceof Object){b={};for(var e in a)a.hasOwnProperty(e)&&(b[e]=clone(a[e]));return b}throw new Error("Unable to copy obj! Its type isn't supported.")}function objectForEach(a,b){for(var c in a)a.hasOwnProperty(c)&&b(c,a[c])}function randomString(a){for(var b="",c="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",d=a;d>0;--d)b+=c[Math.round(Math.random()*(c.length-1))];return b}function statusCallEventName(a){return"terminated"===a&&(a="terminate"),"createdCall"===a&&(a="create"),a}function triggerFacadeProxyClosed(){globalVars.state!==Rtcc.STATES.DESTROYED&&vent.trigger("facade_proxy_closed")}function setPluginRequests(){weemo.requests.name="Plugin",weemo.requests.setRequests(plugin_requests),weemo.responseManager.setParsers(plugin_parsers),globalVars.state=Rtcc.STATES.CONNECTED_TO_FACADE}function setPluginConfig(){weemo.setJsApiVersionToPlugin(),weemo.setUrlReferer(window.location.href),weemo.getConnectionMode()===Rtcc.connectionModes.PLUGIN&&weemo.setPluginMode(global_config.pluginMode),weemo.requests.run("set_user_agent")}function sendConnectPlugin(){var a=global_config.hap||"";modeFacade.send("<connect hap='"+a+"'></connect>")}function MeetingPointHost(a,b){if(b=b||{},this.isNoVideo=!1,"permanent"!==a&&"scheduled"!==a&&"adhoc"!==a&&"hostless"!==a)throw"conftype "+a+"not allowed, allowed types are 'permanent', 'adhoc', 'scheduled', 'hostless'";if("scheduled"===a&&(void 0===b.startDate||void 0===b.stopDate))throw"scheduled conftype require a startDate and an stopDate";this.status=b.status||"created",this.conftype=a,this.callType=void 0,this.hostUrl=b.hostUrl||!1,this.attendeeUrl=b.attendeeUrl||!1,this.id=b.id||!1,this.startDate=b.startDate||!1,this.stopDate=b.stopDate||!1,this.attendees={},this.location=b.location||"",this.title=b.title||"",this.mode=b.mode||"default",this.create=function(){return weemo.requests.run("create_meeting_point",[this])},this.flush=function(){this.attendees={},weemo.requests.run("control_meeting_point",[this.id,"flush"])},this.list=function(){weemo.requests.run("control_meeting_point",[this.id,"list"])},this.modify=function(a){c=a,weemo.requests.run("modify_meeting_point",[this,a])};var c=!1;this.modify_failure_callback=function(){c=!1},this.modify_success_callback=function(){c?(this.startDate=c.startDate||this.startDate,this.stopDate=c.stopDate||this.stopDate,this.title=(c.title||this.title).decodeHTML(),this.location=(c.location||this.location).decodeHTML(),c=!1):debug("should only be called after a successfull modification")},this.remove=function(){return weemo.requests.run("delete_meeting_point",[this.id])};this.invite=function(a){weemo.requests.run("control_meeting_point",[this.id,"invite",a]),this.attendees[a]=new Attendee(this.id,a)},this.lock_mode=function(){this.mode="locked",weemo.requests.run("control_meeting_point",[this.id,this.mode])},this.default_mode=function(){this.mode="default",weemo.requests.run("control_meeting_point",[this.id,this.mode])},this.autoaccept_mode=function(){this.mode="auto-accept",weemo.requests.run("control_meeting_point",[this.id,this.mode])},this.host=function(a){this.isNoVideo=!1,weemo.requests.run("host_meeting_point",[this.id,a])},this.hostNoVideo=function(a){this.isNoVideo=!0,weemo.requests.run("host_meeting_point",[this.id,a])}}function MeetingPointAttendee(a,b){this.id=a,this.hostDisplayName=b,this.status="notJoined",this.cancel=function(){this.status="cancel",weemo.requests.run("control_meeting_point",[this.id,this.status])},this.confHash=!1,this.deny=function(){this.status="denied",weemo.requests.run("control_meeting_point",[this.id,"deny"])},this.request=function(){this.status="waitingForApproval",weemo.requests.run("attend_meeting_point",[this.id])},this.accept=function(){weemo.requests.run("control_meeting_point",[this.id,"accept"]),this.status="ok",weemo.createCall(this.id,"attendee","conference")}}instance++;var rtcc=this,modeMap={plugin_webrtc:"plugin_webrtc",plugin_only:"plugin_only",webrtc_only:"webrtc_only"},mode="plugin_webrtc",downloadUrl="https://download.rtccloud.net/plugin/release/3",global_config,version="6.3.16",endpointUrl="",actions={};actions.authenticate=function(){var a=global_config.rtccUserType,endpointUrl=global_config.endpointUrl;globalVars.force_connect;if("internal"===a||"external"===a||"digit_external"===a)if(""!==endpointUrl&&"internal"===a){var b=new_ajax_request();b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var a=JSON.parse(b.responseText);globalVars.token=a.token,weemo.requests.run("verify_user"),run_client_callback(weemo,"onConnectionHandler",["connectedCloud",0]),apiEvents.trigger("cloud.connect")}if(4===b.readyState&&500===b.status){json=JSON.parse(b.responseText);var c=json.error||json.error_description;c&&(run_client_callback(weemo,"onConnectionHandler",["rtccAuthApiError",c]),apiEvents.trigger("cloud.authenticate.error",c))}},b.open("GET",endpointUrl,!0),b.setRequestHeader("Cache-Control","no-cache"),b.setRequestHeader("If-Modified-Since","Sat, 1 Jan 2005 00:00:00 GMT"),b.send()}else weemo.requests.run("verify_user"),run_client_callback(weemo,"onConnectionHandler",["connectedCloud",0]),apiEvents.trigger("cloud.connect");else run_client_callback(weemo,"onConnectionHandler",["rtccUserTypeNotExist",0]),apiEvents.trigger("cloud.authenticate.error","User type "+a+" does not exists.")},actions.turnProbing=function(a,b,c){function d(a){debug(a)}function e(){}function f(a){l=setTimeout(function(){run_client_callback(weemo,"onConnectionHandler",["unableToReachTurnServer",0]),apiEvents.trigger("cloud.turn.error","Unable to reach TURN server."),b()},k),i.setLocalDescription(a,e,d)}function g(b){b.candidate&&(j||-1==b.candidate.candidate.search("typ relay")||(j=!0,clearTimeout(l),i.close(),run_client_callback(weemo,"onConnectionHandler",["turnProbeOk",0]),apiEvents.trigger("cloud.turn.ok"),a()))}function h(){j=!1;var a=getPeerConnectionConfig(webrtcFacade.turn);i=new RTCPeerConnection(a),i.onicecandidate=g;var b={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};i.createOffer(f,d,b)}if(c)return a();var i,j=!1,k=global_config.turn_probing_timeout,l=!1;h()},actions.start_webrtc=function(a){var b=this,c=function(b){vent.once([{event:"facade_proxy_closed",action:function(){a.on_webrtc_finished("cannot_connect")}},{event:"facade_proxy_opened",action:function(){vent.once({event:"facade_proxy_closed",action:function(){run_client_callback(weemo,"onConnectionHandler",["disconnectedWebRTC",0]),apiEvents.trigger("client.disconnect"),apiEvents.trigger("cloud.disconnect"),a.on_webrtc_finished("disconnected")}}),webrtcFacade.open()}}]),webrtcFacade.connectWebRTC(b)},d=function(d){var e={server:d.probe.server,name:d.probe.name};run_client_callback(weemo,"onConnectionHandler",["probesOk",e]),apiEvents.trigger("cloud.realtimeplatform.ok");var f=d.probe.webrtc;webrtcFacade.webrtc_server=f,webrtcFacade.probe_server=d.probe.server,webrtcFacade.localAddress=d.localAddress,webrtcFacade.latency=d.probe.latency,webrtcFacade.port=d.probe.port,webrtcFacade.turn=d.probe.turn;var g=global_config.webpProtocol+"://"+f;actions.turnProbing(function(){c(g)},function(){a.allow_turn_failure===!0?c(g):a.on_webrtc_finished.call(b,"turn_probing_failed")},a.bypassTurnProbeTest)};vent.once([{event:"hap_ok",action:function(c){vent.once([{event:"probes_ok",action:d},{event:"probes_nok",action:function(){run_client_callback(weemo,"onConnectionHandler",["unableToReachProbes",0]),apiEvents.trigger("cloud.realtimeplatform.error","Unable to reach probes"),a.on_webrtc_finished.call(b,"cannot_connect_probes")}}]),run_client_callback(weemo,"onConnectionHandler",["hapOk",0]),apiEvents.trigger("cloud.haproxy.ok"),webrtcFacade.choose_realtime_platform(c.hap)}},{event:"hap_nok",action:function(){0===global_config.current_hap?global_config.current_hap=1:global_config.current_hap=0,run_client_callback(weemo,"onConnectionHandler",["unableToReachHap",0]),apiEvents.trigger("cloud.haproxy.error","Unable to reach HA proxy"),a.on_webrtc_finished("cannot_connect")}}]),webrtcFacade.getHap()},function(a,b){function c(){run_client_callback(rtcc,"onConnectionHandler",["disconnectedRtccDriver",0]),apiEvents.trigger("client.disconnect"),apiEvents.trigger("cloud.disconnect")}var d=function(a,b){globalVars.timeout.init_timeout_id=setTimeout(function(){a.apply(null,b)},global_config.timeBetweenConnectionAttempts)};a.initialize=function(a){if(run_client_callback(rtcc,"onConnectionHandler",["webRTCCapabilities",Number(webrtc_compliant())]),apiEvents.trigger("webrtc.capability",Number(webrtc_compliant())),global_config.standAlone)e();else{var b=h(global_config.mode_parameter,global_config.os,global_config.force_supported_os,global_config.force_chrome_allows_plugin);debug("mode:"+b),b&&s[b](a)}};var e=function(){a.start_webrtc({bypassTurnProbeTest:!0,on_webrtc_finished:function(a){global_config.standAlone?d(e):rtcc.initialize()}})},f=function(){return global_config.forceIsChrome||"Chrome"===system_info().browser},g=function(){return"Chrome"===system_info().browser||"iOS"===system_info().os||"Android"===system_info().os},h=function(a,b,c,d){return"webrtc_plugin"===a&&(a="plugin_webrtc"),debug("convert_mode_from_contextmode:"+a),global_config.force_chrome_allows_plugin===!1&&f()&&"plugin_only"===a&&plugin_supports_os(b,c)?"extension_only":f()&&"plugin_webrtc"===a&&plugin_supports_os(b,c)&&global_config.force_chrome_allows_plugin===!1?"extension_webrtc":d!==!0&&g()&&"plugin_only"===a?(apiEvents.trigger("plugin.browser.error"),!1):("plugin_webrtc"!==a||plugin_supports_os(b,c)||webrtc_compliant())&&("plugin_only"!==a||plugin_supports_os(b,c))?"webrtc_only"!==a||webrtc_compliant()?"plugin_webrtc"!==a||plugin_supports_os(b,c)?"plugin_webrtc"!==a||webrtc_compliant()?s.hasOwnProperty(a)?a:(debug("Mode:"+a+" Not recongnized"),!1):"plugin_only":"webrtc_only":(debug("Mode set to webRTC only, but browser not compatible with webRTC"),run_client_callback(rtcc,"onConnectionHandler",["browserCompatibilityError",null]),apiEvents.trigger("webrtc.browser.error"),!1):(run_client_callback(rtcc,"onConnectionHandler",["unsupportedOS",0]),apiEvents.trigger("error.ossupport"),apiEvents.trigger("plugin.browser.error"),debug("Mode:"+a+"unsupportedOS"),!1)},i=function(){window.addEventListener("message",rtcc._extensionReadyListener),rtcc.addMessageEventListener(rtcc.responseManager.handle.bind(rtcc.responseManager)),m()},j=function(){window.addEventListener("message",rtcc._extensionReadyListener),rtcc.addMessageEventListener(rtcc.responseManager.handle.bind(rtcc.responseManager)),n()},k=function(){var a=(new Date).valueOf(),b=function(c,d){if(null!==document.getElementById("rtcc-nm-installed"))c();else{var e=(new Date).valueOf();e-a>=global_config.extensionWaitTime?d("extension_missing"):setTimeout(function(){b(c,d)},global_config.extentionWaitTime/5)}};return new Promise(function(a,c){b(a,c)})},l=function(a){return new Promise(function(b,e){facade_proxy_plugin_missing=function(){e("plugin_missing")};var f=function(){vent.once({event:"facade_proxy_closed",action:function(){c(),globalVars.presence_state=Rtcc.PRESENCE_STATES.NOK,globalVars.state=Rtcc.STATES.NOT_CONNECTED_TO_FACADE,d(a)}}),extensionFacade.open(),b()};vent.once([{event:"facade_proxy_plugin_missing",action:facade_proxy_plugin_missing},{event:"facade_proxy_opened",action:f}]),extensionFacade.connect()})},m=function(a,b){k().then(function(){return l(m)["catch"](function(){b!==!0&&downloadPlugin.call(rtcc),d(function(){m(!0,!0)})})})["catch"](function(b){a!==!0&&apiEvents.trigger("chrome.extension.missing","https://chrome.google.com/webstore/detail/sightcall-chrome-extensio/eohghiagfdiblfddjokjelgpkmokpoal"),d(function(){m(!0)}),debug("RTCCextension failed, cannot reach extension trying again...")})},n=function(){k().then(function(){return l(n)})["catch"](function(b){debug("plugin_missing"==b?"RTCCextension failed, plugin missing connecting in webrtc":"RTCCextension failed, cannot reach extension connecting in webrtc"),loadUi(),a.start_webrtc({bypassTurnProbeTest:global_config.bypassTurnProbeTest,on_webrtc_finished:function(a){"turn_probing_failed"===a||"cannot_connect_probes"===a?m():d(n)}},global_config)})},o=!1,p=function(){function a(){clearTimeout(globalVars.timeout.pluginConnect),globalVars.presence_state=Rtcc.PRESENCE_STATES.NOK,globalVars.state=Rtcc.STATES.NOT_CONNECTED_TO_FACADE,d(p)}var b=function(){o||(downloadPlugin.call(rtcc),o=!0),a()},e=function(){vent.once({event:"facade_proxy_closed",action:function(){c(),a()}}),pluginFacade.open()};vent.once([{event:"facade_proxy_opened",action:e},{event:"facade_proxy_closed",action:b}]),pluginFacade.connect()},q=function(){var b=function(){debug("RTCCplugin not installed or disconnected, starting webrtc"),loadUi(),clearTimeout(globalVars.timeout.pluginConnect),a.start_webrtc({bypassTurnProbeTest:global_config.bypassTurnProbeTest,on_webrtc_finished:function(a){"turn_probing_failed"===a||"cannot_connect_probes"===a?(downloadPlugin.call(rtcc),q({has_called_onRtccDriverNotStarted:!0})):d(q)}},global_config)},e=function(){vent.once({event:"facade_proxy_closed",action:function(){clearTimeout(globalVars.timeout.pluginConnect),globalVars.state=Rtcc.STATES.NOT_CONNECTED_TO_FACADE,globalVars.presence_state=Rtcc.PRESENCE_STATES.NOK,c(),d(q)}}),pluginFacade.open()};vent.once([{event:"facade_proxy_opened",action:e},{event:"facade_proxy_closed",action:b}]),pluginFacade.connect()},r=function(){loadUi(),a.start_webrtc({bypassTurnProbeTest:global_config.bypassTurnProbeTest,allow_turn_failure:!0,on_webrtc_finished:function(a){"turn_probing_failed"===a||"cannot_connect_probes"===a?(run_client_callback(rtcc,"onWebrtcImpossibleOnThisNetwork"),apiEvents.trigger("webrtc.missing","WebRTC unavailable on this network.")):d(r)}},global_config)},s={plugin_only:p,extension_only:i,extension_webrtc:j,webrtc_only:r,plugin_webrtc:q}}(actions,this);var arrayContains=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1},arrayForEach=function(a,b,c){var d,e;if(null===a)throw new TypeError(" array is null or not defined");var f=Object(a),g=f.length>>>0;if("function"!=typeof b)throw new TypeError(b+" is not a function");for(c&&(d=c),e=0;g>e;){var h;e in f&&(h=f[e],b.call(d,h,e,f)),e++}},bindObjectToVent=function(a,b){a.on=b.on.bind(b),a.off=b.off.bind(b),a.onAll=b.onAll.bind(b),a.offAll=b.offAll.bind(b),a.trigger=b.trigger.bind(b)},new_cross_domain_request=function(){var a=null;return window.XDomainRequest?a=new XDomainRequest:window.XMLHttpRequest?a=new XMLHttpRequest:debug("Your browser does not support AJAX cross-domain!"),a},debug=function(a,b){b=b||{};var c=b.header||!1,d=b.show_on_debug_level;void 0===d&&(d=1),Number(global_config.debugLevel)>=d&&(c&&Rtcc._safelog(c),Rtcc._safelog("instance:"+global_config.instance+"   "+a))},XmlDoc=function(a){return window.DOMParser?(parser=new DOMParser,xmlDoc=parser.parseFromString(a,"text/xml")):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async=!1,xmlDoc.loadXML(a)),xmlDoc},generateSuffix=function(){var a=localStorage.getItem("sightcall_suffix");return a?a:(a=randomString(16),localStorage.setItem("sightcall_suffix",a),a)},getPeerConnectionConfig=function(a){for(var b=global_config.iceConfig,c={iceServers:[]},d=[],e=0;e<b.length;e++)d.push(b[e].replace("[turn_candidate]",a));var f={urls:d,username:"weemo",credential:"weemo"};return null!==f&&(c.iceServers=c.iceServers.concat(f)),c},getSuffix=function(){if("external"!==global_config.rtccUserType)return debug("This function is only applicable to rtccUserType external"),!1;var a=localStorage.getItem("sightcall_suffix");return a?a:(debug("Sufix has not yet been generated, it is generated after calling rtcc.initialize"),!1)},isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},load_configs=function(a,b){var c=get_global_config_defaults(b);return c.appId=a[0],globalVars.token=a[1],c.rtccUserType=a[2],"object"==typeof a[3]?c=Rtcc.merge(c,a[3]):("string"==typeof a[3]&&(c.hap=a[3]),void 0!==a[4]&&(c.debugLevel=Number(a[4])),void 0!==a[5]&&(c.displayName=a[5]),void 0!==a[6]&&(c.useJquery=a[6]),c.defaultStyle=void 0!==a[7]?a[7]:!0,c=Rtcc.merge(c,a[8])),c.useJquery=!1,c},load_script=function(a,b){var c=document.createElement("script");c.src=a,c.onload=function(){b&&b()};var d=document.getElementsByTagName("head")[0];d.appendChild(c)};Rtcc.merge=function(){for(var a,b={},c=0,d=arguments.length;d>c;c++)for(a in arguments[c])arguments[c].hasOwnProperty(a)&&(b[a]=arguments[c][a]);return b};var new_ajax_request=function(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")};Object.keys||(Object.keys=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}());var parseHapXml=function(a){var b,c,d=new XmlDoc(a),e={};e.tuntab=[];var f=d.getElementsByTagName("techdomain")[0];void 0!==f&&(e.techdomain=d.getElementsByTagName("techdomain")[0].childNodes[0].nodeValue);var g=d.getElementsByTagName("local")[0];void 0!==g&&(e.localAddress=d.getElementsByTagName("local")[0].getAttribute("addr"));var h=d.getElementsByTagName("tun").length;if(void 0!==h)for(var i=0;h>i;i+=1)if(d.getElementsByTagName("tun")[i].getElementsByTagName("probews")[0]){b=d.getElementsByTagName("tun")[i].getAttribute("name"),c=d.getElementsByTagName("tun")[i].getElementsByTagName("probews")[0].getAttribute("addr");var j=d.getElementsByTagName("tun")[i].getElementsByTagName("probews")[0].getAttribute("port"),k=d.getElementsByTagName("tun")[i].getElementsByTagName("webrtc")[0],l=d.getElementsByTagName("tun")[i].getElementsByTagName("probe")[0].getAttribute("addr");e.tuntab.push({name:b,address:c,port:j,webrtc:k.getAttribute("addr")+":"+k.getAttribute("port"),turn:l})}return e},plugin_supports_os=function(a,b){return b||"linux"!==a&&"unix"!==a&&"Linux"!==a&&"Unix"!==a&&"Android"!==a&&"iOS"!==a};!function(){function a(a,b){return this.slice(a,b)}function b(a,b){arguments.length<2&&(b=0);for(var c=0,d=a.length;d>c;++c,++b)this[b]=255&a[c]}function c(c){var d;if("number"==typeof c){d=new Array(c);for(var e=0;c>e;++e)d[e]=0}else d=c.slice(0);return d.subarray=a,d.buffer=d,d.byteLength=d.length,d.set=b,"object"==typeof c&&c.buffer&&(d.buffer=c.buffer),d}try{new Uint8Array(1);return}catch(d){}window.Uint8Array=c,window.Uint32Array=c,window.Int32Array=c}();var run_client_callback=function(a,b,c,d){if("function"==typeof a[b])try{debug("WARNING "+b+" is depreciated please use events instead, see javascript api documentation `rtcc.on('event_name', cb)`"),a[b].apply(a,c)}catch(e){debug("error in callback function"),debug(e.stack)}else"function"==typeof d&&(debug("callback "+b+" not present, running default function"),d())},strpos=function(a,b,c){var d=String(a).indexOf(b,c||0);return-1===d&&(d=!1),d},system_info=function(){function a(){system_info.data={};var a,b,c="Unbekannt";screen.width&&(a=screen.width?screen.width:"",b=screen.height?screen.height:"",screenSize=a+" x "+b);var d=navigator.appVersion,e=navigator.userAgent;system_info.data.browser=navigator.appName,system_info.data.browserVersion=""+parseFloat(navigator.appVersion);var f,g,h,i=parseInt(navigator.appVersion,10);-1!=(g=e.indexOf("Opera"))?(system_info.data.browser="Opera",system_info.data.browserVersion=e.substring(g+6),-1!=(g=e.indexOf("Version"))&&(system_info.data.browserVersion=e.substring(g+8))):-1!=(g=e.indexOf("MSIE"))?(system_info.data.browser="Microsoft Internet Explorer",system_info.data.browserVersion=e.substring(g+5)):-1!=(g=e.indexOf("Trident/7."))?(system_info.data.browser="Microsoft Internet Explorer",-1!=(g=e.indexOf("rv:"))&&(system_info.data.browserVersion=e.substring(g+3,g+7))):-1!=(g=e.indexOf("Chrome"))?(system_info.data.browser="Chrome",system_info.data.browserVersion=e.substring(g+7)):-1!=(g=e.indexOf("Safari"))?(system_info.data.browser="Safari",system_info.data.browserVersion=e.substring(g+7),-1!=(g=e.indexOf("Version"))&&(system_info.data.browserVersion=e.substring(g+8))):-1!=(g=e.indexOf("Firefox"))?(system_info.data.browser="Firefox",system_info.data.browserVersion=e.substring(g+8)):(f=e.lastIndexOf(" ")+1)<(g=e.lastIndexOf("/"))&&(system_info.data.browser=e.substring(f,g),system_info.data.browserVersion=e.substring(g+1),system_info.data.browser.toLowerCase()==system_info.data.browser.toUpperCase()&&(system_info.data.browser=navigator.appName)),-1!=(h=system_info.data.browserVersion.indexOf(";"))&&(system_info.data.browserVersion=system_info.data.browserVersion.substring(0,h)),-1!=(h=system_info.data.browserVersion.indexOf(" "))&&(system_info.data.browserVersion=system_info.data.browserVersion.substring(0,h)),i=parseInt(""+system_info.data.browserVersion,10),isNaN(i)&&(system_info.data.browserVersion=""+parseFloat(navigator.appVersion),i=parseInt(navigator.appVersion,10)),system_info.data.mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(d),system_info.data.cookieEnabled=navigator.cookieEnabled?!0:!1,"undefined"!=typeof navigator.cookieEnabled||cookieEnabled||(document.cookie="testcookie",system_info.data.cookieEnabled=-1!=document.cookie.indexOf("testcookie")?!0:!1),system_info.data.os=c;var j=[{s:"Windows 3.11",r:/Win16/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows ME",r:/Windows ME/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var k in j){var l=j[k];if(l.r.test(e)){system_info.data.os=l.s;break}}switch(system_info.data.osVersion=c,/Windows/.test(system_info.data.os)&&(system_info.data.osVersion=/Windows (.*)/.exec(system_info.data.os)[1],system_info.data.os="Windows"),system_info.data.os){case"Mac OS X":var m=/Mac OS X (10[\.\_\d]+)/.exec(e);m&&(system_info.data.osVersion=m[1]);break;case"Android":system_info.data.osVersion=/Android ([\.\_\d]+)/.exec(e)[1];break;case"iOS":system_info.data.osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(d),system_info.data.osVersion=system_info.data.osVersion[1]+"."+system_info.data.osVersion[2]+"."+(0|system_info.data.osVersion[3])}"Microsoft Internet Explorer"===system_info.data.browser&&system_info.data.browserVersion<12?(system_info.data.useSockets=!1,system_info.data.downloadTimeoutValue=2e4):(system_info.data.useSockets=!0,system_info.data.downloadTimeoutValue=8e3)}return void 0===system_info.data&&a(),system_info.data};uniqid=function(){return(new Date).getTime()%2147483647};var webrtc_compliant=function(){return("Chrome"===system_info().browser||global_config.forceWebRtcCompliant)&&!global_config.forceNotWebRtcCompliant};String.prototype.encodeHTML||(String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}),String.prototype.decodeHTML||(String.prototype.decodeHTML=function(){return this.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&")});var JXON=function(){function a(a,b){var c={toObj:function(a){var b={};if(1==a.nodeType){if(a.attributes.length)for(var d=0;d<a.attributes.length;d++)b["@"+a.attributes[d].nodeName]=(a.attributes[d].nodeValue||"").toString();if(a.firstChild){for(var e=0,f=0,g=!1,h=a.firstChild;h;h=h.nextSibling)1==h.nodeType?g=!0:3==h.nodeType&&h.nodeValue.match(/[^ \f\n\r\t\v]/)?e++:4==h.nodeType&&f++;if(g)if(2>e&&2>f){c.removeWhite(a);for(var h=a.firstChild;h;h=h.nextSibling)3==h.nodeType?b["#text"]=c.escape(h.nodeValue):4==h.nodeType?b["#cdata"]=c.escape(h.nodeValue):b[h.nodeName]?b[h.nodeName]instanceof Array?b[h.nodeName][b[h.nodeName].length]=c.toObj(h):b[h.nodeName]=[b[h.nodeName],c.toObj(h)]:b[h.nodeName]=c.toObj(h)}else a.attributes.length?b["#text"]=c.escape(c.innerXml(a)):b=c.escape(c.innerXml(a));else if(e)a.attributes.length?b["#text"]=c.escape(c.innerXml(a)):b=c.escape(c.innerXml(a));else if(f)if(f>1)b=c.escape(c.innerXml(a));else for(var h=a.firstChild;h;h=h.nextSibling)b["#cdata"]=c.escape(h.nodeValue)}a.attributes.length||a.firstChild||(b=null)}else 9==a.nodeType?b=c.toObj(a.documentElement):alert("unhandled node type: "+a.nodeType);return b},toJson:function(a,b,d){var e=b?'"'+b+'"':"";if(a instanceof Array){for(var f=0,g=a.length;g>f;f++)a[f]=c.toJson(a[f],"",d+"	");e+=(b?":[":"[")+(a.length>1?"\n"+d+"	"+a.join(",\n"+d+"	")+"\n"+d:a.join(""))+"]"}else if(null==a)e+=(b&&":")+"null";else if("object"==typeof a){var h=[];for(var i in a)h[h.length]=c.toJson(a[i],i,d+"	");e+=(b?":{":"{")+(h.length>1?"\n"+d+"	"+h.join(",\n"+d+"	")+"\n"+d:h.join(""))+"}"}else e+="string"==typeof a?(b&&":")+'"'+a.toString()+'"':(b&&":")+a.toString();return e},innerXml:function(a){var b="";if("innerHTML"in a)b=a.innerHTML;else for(var c=function(a){var b="";if(1==a.nodeType){b+="<"+a.nodeName;for(var d=0;d<a.attributes.length;d++)b+=" "+a.attributes[d].nodeName+'="'+(a.attributes[d].nodeValue||"").toString()+'"';if(a.firstChild){b+=">";for(var e=a.firstChild;e;e=e.nextSibling)b+=c(e);b+="</"+a.nodeName+">"}else b+="/>"}else 3==a.nodeType?b+=a.nodeValue:4==a.nodeType&&(b+="<![CDATA["+a.nodeValue+"]]>");return b},d=a.firstChild;d;d=d.nextSibling)b+=c(d);return b},escape:function(a){return a.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(a){a.normalize();for(var b=a.firstChild;b;)if(3==b.nodeType)if(b.nodeValue.match(/[^ \f\n\r\t\v]/))b=b.nextSibling;else{var d=b.nextSibling;a.removeChild(b),b=d}else 1==b.nodeType?(c.removeWhite(b),b=b.nextSibling):b=b.nextSibling;return a}};9==a.nodeType&&(a=a.documentElement);var d=c.toJson(c.toObj(c.removeWhite(a)),a.nodeName,"	");return"{\n"+b+(b?d.replace(/\t/g,b):d.replace(/\t|\n/g,""))+"\n}"}function b(a,b){var c=function(a,b,d){var e="";if(a instanceof Array)for(var f=0,g=a.length;g>f;f++)e+=d+c(a[f],b,d+"	")+"\n";else if("object"==typeof a){var h=!1;e+=d+"<"+b;for(var i in a)"@"==i.charAt(0)?e+=" "+i.substr(1)+'="'+a[i].toString()+'"':h=!0;if(e+=h?">":"/>",h){for(var i in a)"#text"==i?e+=a[i]:"#cdata"==i?e+="<![CDATA["+a[i]+"]]>":"@"!=i.charAt(0)&&(e+=c(a[i],i,d+"	"));e+=("\n"==e.charAt(e.length-1)?d:"")+"</"+b+">"}}else e+=d+"<"+b+">"+a.toString()+"</"+b+">";return e},d="";for(var e in a)d+=c(a[e],e,"");return b?d.replace(/\t/g,b):d.replace(/\t|\n/g,"")}var c={};c.xmlString2jsonObject=function(a){return xmlDoc=d(a),c.xmlDoc2jsonObject(xmlDoc)},c.xmlDoc2jsonObject=function(b){return JSON.parse(a(b,""))},c.jsonObject2xmlString=function(a){return b(a,"")};var d=function(a){return XmlDoc(a,"text/xml")};return c}(),StateManager=function(a,b,c){c=c||!1;for(var d={},e=!1,f=0;f<a.length;f++)d[a[f]]=!1;this.reach=function(a){if(void 0===d[a])throw new Error("unknown state "+a);return d[a]=!0,this},this.tryRun=function(){for(var f=0;f<a.length;f++)if(d[a[f]]===!1)return!1;return c&&e||(b(),e=!0),!0},this.setCallback=function(a,d){return c=d||!1,b=a,this}},sdpParser={};!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){!function(b){var c=a("sdp-transform");b.parseSDP=c.parse,b.writeSDP=c.write,b.parseFmtpConfig=c.parseFmtpConfig,b.parsePayloads=c.parsePayloads,b.parseRemoteCandidates=c.parseRemoteCandidates}(sdpParser)},{"sdp-transform":3}],2:[function(a,b,c){var d=b.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],
m:[{reg:/^(\w*) (\d*) ([\w\/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-]*)\/(\d*)(?:\s*\/(\S*))?/,names:["payload","codec","rate","encoding"],format:function(a){return a.encoding?"rtpmap:%d %s/%s/%s":"rtpmap:%d %s/%s"}},{push:"fmtp",reg:/^fmtp:(\d*) (\S*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(a){return null!=a.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(a){return null!=a.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:([\w_\/]*) (\S*)(?: (\S*))?/,names:["value","uri","config"],format:function(a){return null!=a.config?"extmap:%s %s %s":"extmap:%s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(a){return null!=a.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"mid",reg:/^mid:(\w*)/,format:"mid:%s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/,format:"%s"},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","generation"],format:function(a){var b="candidate:%s %d %s %d %s %d typ %s";return b+=null!=a.raddr?" raddr %s rport %d":"%v%v",null!=a.generation&&(b+=" generation %d"),b}},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_]*):(.*)/,names:["id","attribute","value"],format:"ssrc:%d %s:%s"},{name:"msidSemantic",reg:/^msid-semantic: (\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{push:"invalid",names:["value"]}]};arrayForEach(Object.keys(d),function(a){var b=d[a];arrayForEach(b,function(a){a.reg||(a.reg=/(.*)/),a.format||(a.format="%s")})})},{}],3:[function(a,b,c){var d=a("./parser"),e=a("./writer");c.write=e,c.parse=d.parse,c.parseFmtpConfig=d.parseFmtpConfig,c.parsePayloads=d.parsePayloads,c.parseRemoteCandidates=d.parseRemoteCandidates},{"./parser":4,"./writer":5}],4:[function(a,b,c){var d=function(a){return String(Number(a))===a?Number(a):a},e=function(a,b,c,e){if(e&&!c)b[e]=d(a[1]);else for(var f=0;f<c.length;f+=1)null!=a[f+1]&&(b[c[f]]=d(a[f+1]))},f=function(a,b,c){var d=a.name&&a.names;a.push&&!b[a.push]?b[a.push]=[]:d&&!b[a.name]&&(b[a.name]={});var f=a.push?{}:d?b[a.name]:b;e(c.match(a.reg),f,a.names,a.name),a.push&&b[a.push].push(f)},g=a("./grammar"),h=RegExp.prototype.test.bind(/^([a-z])=(.*)/);c.parse=function(a){var b={},c=[],d=b;return a.split("\r\n").filter(h).forEach(function(a){var b=a[0],e=a.slice(2);"m"===b&&(c.push({rtp:[],fmtp:[]}),d=c[c.length-1]);for(var h=0;h<(g[b]||[]).length;h+=1){var i=g[b][h];if(i.reg.test(e))return f(i,d,e)}}),b.media=c,b};var i=function(a,b){var c=b.split("=");return 2===c.length&&(a[c[0]]=d(c[1])),a};c.parseFmtpConfig=function(a){return a.split(";").reduce(i,{})},c.parsePayloads=function(a){return a.split(" ").map(Number)},c.parseRemoteCandidates=function(a){for(var b=[],c=a.split(" ").map(d),e=0;e<c.length;e+=3)b.push({component:c[e],ip:c[e+1],port:c[e+2]});return b}},{"./grammar":2}],5:[function(a,b,c){var d=a("./grammar"),e=/%[sdv%]/g,f=function(a){var b=1,c=arguments,d=c.length;return a.replace(e,function(a){if(b>=d)return a;var e=c[b];switch(b+=1,a){case"%%":return"%";case"%s":return String(e);case"%d":return Number(e);case"%v":return""}})},g=function(a,b,c){var d=b.format instanceof Function?b.format(b.push?c:c[b.name]):b.format,e=[a+"="+d];if(b.names)for(var g=0;g<b.names.length;g+=1){var h=b.names[g];b.name?e.push(c[b.name][h]):e.push(c[b.names[g]])}else e.push(c[b.name]);return f.apply(null,e)},h=["v","o","s","i","u","e","p","c","b","t","r","z","a"],i=["i","c","b","a"];b.exports=function(a,b){b=b||{},null==a.version&&(a.version=0),null==a.name&&(a.name=" "),a.media.forEach(function(a){null==a.payloads&&(a.payloads="")});var c=b.outerOrder||h,e=b.innerOrder||i,f=[];return c.forEach(function(b){d[b].forEach(function(c){c.name in a?f.push(g(b,c,a)):c.push in a&&a[c.push].forEach(function(a){f.push(g(b,c,a))})})}),a.media.forEach(function(a){f.push(g("m",d.m[0],a)),e.forEach(function(b){d[b].forEach(function(c){c.name in a?f.push(g(b,c,a)):c.push in a&&a[c.push].forEach(function(a){f.push(g(b,c,a))})})})}),f.join("\r\n")+"\r\n"}},{"./grammar":2}]},{},[1]);var Vent=function(){this.events={},this.allEvents={}};!function(){function a(a){return a instanceof Array?array=a:void 0===a?array=[]:array=[a],array}function b(a,b,c,d){for(var e=0;e<b.length;e++){var f=b[e];a[f]||(a[f]=[]),a[f].push({context:d,callback:c})}return a}function c(a,b,c,d){var e="function"==typeof c,f="object"==typeof d&&null!==d;if(0===b.length)a={};else for(var g=0;g<b.length;g++){var h=b[g],i=a[h];if(i)if(e){for(var j=i.length-1;j>=0;j--){var k=i[j];k.callback===c&&(f?k.context===d&&i.splice(j,1):i.splice(j,1))}0===i.length&&delete a[h]}else delete a[h]}return a}function d(a,b,c){for(var d,e=0,d=a.length;d>e;e++){var f=a[e],g=f.context||{};g.eventName=c;try{f.callback.apply(g,b)}catch(h){Rtcc._safelog("Error in callback"),Rtcc._safelog(h.stack)}}}Vent.prototype={on:function(c,d,e){return this.events=b(this.events,a(c),d,e),this},onAll:function(a,c){return this.allEvents=b(this.allEvents,["all"],a,c),this},off:function(b,d,e){return this.events=c(this.events,a(b),d,e),this},offAll:function(a,b){return this.allEvents=c(this.allEvents,["all"],a,b),this},trigger:function(b){b=a(b);for(var c=Array.prototype.slice.call(arguments).slice(1),e=0;e<b.length;e++){var f=this.events[b[e]];f&&d(f,c,b[e]);var g=this.allEvents.all;g&&d(g,c,b[e])}return this}}}(),Vent.prototype.once=function(a){var b,c=this,d=[];b=a instanceof Array?a:[a];for(var e=function(a){return function(){b[a].action&&b[a].action.apply(this,arguments),f()}},f=function(){for(var a=0;a<b.length;a++)c.off(b[a].event,d[a])},g=0;g<b.length;g++)d.push(e(g)),this.on(b[g].event,d[g])};var modeFacade={},weemo=this,vent=new Vent,extensionFacade={},webrtcFacade={};extensionFacade.connect=function(){window.postMessage({type:"CONNECT_JS_RTCC"},"*")},extensionFacade.getConnectionMode=function(){return Rtcc.connectionModes.EXTENTION},extensionFacade.open=function(){modeFacade=extensionFacade,setPluginRequests(),setPluginConfig(),sendConnectPlugin()},extensionFacade.send=function(a,b){a=a||"",b=b||{},b.header="BROWSER >>>> EXTENSION",debug(a,b),Rtcc.postMessage(a)};var socket_on_closing_check=function(a,b){var c=function(){(a.readyState===WebSocket.CLOSING||a.readyState===WebSocket.CLOSED)&&(clearInterval(d),b())},d=setInterval(c,global_config.interval_to_check_socket_closed)},create_socket_connection=function(a,b){global_config.browser;try{if(this.websock&&(this.websock.onopen=null,this.websock.onclose=null,this.websock.onmessage=null,this.websock.onerror=null,this.websock=null),b)this.websock=new WebSocket(a,b),this.websock.onopen=function(){vent.trigger("facade_proxy_opened")};else{this.websock=new WebSocket(a);var c,d=this;this.websock.onopen=function(){vent.trigger("facade_proxy_opened"),c=new DisconnectOnNoResponse(d)}}socket_on_closing_check(this.websock,function(){debug("BROWSER >>>>> SOCKET IS CLOSE"),c&&c.clean(),triggerFacadeProxyClosed()}),this.websock.onmessage=function(a){weemo.responseManager.handle(a.data)!==!0&&debug(a.data+"not handled")},this.websock.onerror=function(a){debug("BROWSER >>>>> SOCKET ERROR"),debug(a)}}catch(e){debug("BROWSER >>>>> SOCKET EXCEPTION"),debug(e)}},loadUi=function(a){var b=function(){globalVars.webRtcUi||createUi(),a&&a()};if("object"!=typeof RtccUi){var c=(global_config.debugLevel>=1?"":".min",global_config.uiVersion?"https://static.rtccloud.net/ui/"+global_config.uiVersion+"/RtccUi.js":global_config.uiUrl);load_script(c,b)}else b()},createUi=function(){globalVars.webRtcUi=new RtccUi.WebRtcUi(global_config,weemo),run_client_callback(weemo,"onGetHandler",["uiLoaded",0]),apiEvents.trigger("ui.ready")};webrtcFacade.choose_realtime_platform=function(a){function b(){o.techdomain=a.techdomain,o.localAddress=a.localAddress;var b=function(b){h(b.data,a)},c=function(a){debug("SOCKET PROBE ERROR")};if(!(a.tuntab.length>0))throw"no serversfound";for(var d=0;d<a.tuntab.length;d++){var e=new WebSocket(global_config.probeProtocol+"://"+a.tuntab[d].address+":"+a.tuntab[d].port);i(e,d),j(e,d),e.onmessage=b,e.onerror=c,k.push(e)}}function c(a,b){for(var c=a.length,d=String(c),e=d.length,f=e;b>f;f++)d="0"+d;return d}function d(a){var b=m[a],d=n[b];return d=String(a)+d,c(d,5)+":"+d}function e(a,b){1006===a.code&&p&&o.unreachable.push(a.currentTarget.URL),o.unreachable.length===k.length&&(debug("Probes NOK"),vent.trigger("probes_nok"))}function f(a){l[a]=(new Date).getTime(),m[a]=0,k[a].send(d(a))}function g(){for(var a=0;a<k.length;a++)k[a].close()}function h(a,b){var c=Number(a.substring(6,7));if(m[c]+=1,m[c]<n.length)k[c].send(d(c));else{var e=(new Date).getTime(),f=e-l[c];p=!1,g(),debug("--------------------------"),latency=f/n.length,server=b.tuntab[c].address;var h=b.tuntab[c].name;o.probe={name:h,server:server,latency:latency,webrtc:b.tuntab[c].webrtc,turn:b.tuntab[c].turn,port:b.tuntab[c].port},vent.trigger("probes_ok",o)}}function i(a,b){a.onopen=function(a,c){f(b)}}function j(a,b){a.onclose=function(a){e(a,b)}}var k=[],l=[],m=[],n=[randomString(982),randomString(146),randomString(374),randomString(450),randomString(906),randomString(70),randomString(1362),randomString(1058),randomString(222),randomString(526),randomString(1210),randomString(830),randomString(754),randomString(602),randomString(1134),randomString(298)],o={};o.unreachable=[];var p=!0;b()},webrtcFacade.connectWebRTC=function(a){create_socket_connection.call(this,a,void 0)};var DisconnectOnNoResponse=function(){debug("DisconnectOnNoResponse init");var a,b=global_config.webp_timeout,c=global_config.webp_timebetweenpings,d=function(){clearTimeout(a),debug("DisconnectOnNoResponse timeoutReached");var b=global_config.callObjects;objectForEach(b,function(a,b){"function"==typeof b.clean&&b.clean()}),webrtcFacade.websock.close()};this.clean=function(){clearTimeout(a),clearTimeout(globalVars.timeout.disconnect_on_no_pong_timeoutid),vent.off("pong")};var e=function(){vent.off("pong"),debug("DisconnectOnNoResponse run"),vent.on("pong",function(){clearTimeout(globalVars.timeout.disconnect_on_no_pong_timeoutid),debug("DisconnectOnNoResponse clearTimeout"),a=setTimeout(e,c)}),globalVars.timeout.disconnect_on_no_pong_timeoutid=setTimeout(d,b),webrtcFacade.send({cmd:"ping",args:[]},{show_on_debug_level:2})};e()};webrtcFacade.getConnectionMode=function(){return Rtcc.connectionModes.WEBRTC},webrtcFacade.getHap=function(){var a=global_config.hap,b=new_ajax_request(),c=global_config.hap_url[global_config.current_hap]+"/"+a;b.onload=function(){if(200===b.status){var a=parseHapXml(b.responseText);vent.trigger("hap_ok",{hap:a})}else vent.trigger("hap_nok")},b.onerror=function(){debug("ERROR TO GET HAP 1 FILE"),vent.trigger("hap_nok")},b.ontimeout=function(){debug("TIMEOUT TO GET HAP 1 FILE"),vent.trigger("hap_nok")},b.open("GET",c),b.timeout=16e3,b.send()},webrtcFacade.open=function(){modeFacade=webrtcFacade,weemo.requests.name="WebRtc",weemo.requests.setRequests(webrtc_requests),weemo.responseManager.setParsers(webrtc_parsers),globalVars.state=Rtcc.STATES.CONNECTED_TO_FACADE,actions.authenticate(global_config)},webrtcFacade.send=function(a,b){b=b||{};var c=JSON.stringify(a);webrtcFacade.websock.send(c),b.header="BROWSER >>>> SOCKET (WEBRTC)",debug(c,b)};var pluginFacade={};pluginFacade.msBetweenAccessAttemps=500,pluginFacade.requirePermissionFired=!1,pluginFacade.timeWaitedForAccess=0,pluginFacade.pluginInfo={name:"RTCCplugin",activeXName:"Weemo.RTCCplugin"},pluginFacade.callback=function(a,b,c){switch(globalVars.timeout.pluginConnect&&(clearTimeout(globalVars.timeout.pluginConnect),globalVars.timeout.pluginConnect=!1,debug("First message from the plugin",{show_on_debug_level:2}),debug("type: "+a,{show_on_debug_level:2}),debug(b,{show_on_debug_level:2})),a){case"SendXml":weemo.responseManager.handle(b.xml);break;case"disconnect":triggerFacadeProxyClosed()}},pluginFacade.connect=function(){function a(){if(void 0!==global_config.forcePluginStatus)return global_config.forcePluginStatus;if("ActiveXObject"in window)try{new ActiveXObject(pluginFacade.pluginInfo.activeXName);return!0}catch(a){return debug(a),!1}else if(navigator.plugins)return navigator.plugins.refresh(!1),void 0!==navigator.plugins[pluginFacade.pluginInfo.name]}function b(){globalVars.pluginObject.setCallback(pluginFacade.callback)?(debug("Plugin ready!"),apiEvents.trigger("plugin.load"),vent.trigger("facade_proxy_opened")):(debug("Tried to set plugin callback"),globalVars.timeout.pluginSetCallback=setTimeout(b,500))}function c(){return sightcallPluginLoaded===!0}function d(a){c()?(pluginFacade.timeWaitedForAccess=0,a()):(debug("Plugin not activated yet.",{show_on_debug_level:1}),e(),globalVars.timeout.pluginDetection=setTimeout(d.bind(this,a),pluginFacade.msBetweenAccessAttemps))}function e(){pluginFacade.timeWaitedForAccess+=pluginFacade.msBetweenAccessAttemps,!pluginFacade.requirePermissionFired&&pluginFacade.timeWaitedForAccess>5e3&&(apiEvents.trigger("plugin.requirepermission"),pluginFacade.requirePermissionFired=!0)}a()?(global_config.plugin=!0,loadUi(function(){globalVars.pluginObject=globalVars.webRtcUi.getPlugin(),d(b)})):triggerFacadeProxyClosed()},pluginFacade.getConnectionMode=function(){return Rtcc.connectionModes.PLUGIN},pluginFacade.open=function(){modeFacade=pluginFacade,setPluginRequests(),setPluginConfig(),clearTimeout(globalVars.timeout.pluginConnect),function a(){globalVars.timeout.pluginConnect=setTimeout(a,global_config.timeBetweenConnectionAttempts),sendConnectPlugin()}()},pluginFacade.removePlugin=function(){sightcallPluginLoaded=!1,globalVars.webRtcUi.destroy()};var isPluginAvailable=function(){return globalVars.pluginObject&&("function"==typeof globalVars.pluginObject.sendMessage||"object"==typeof globalVars.pluginObject.sendMessage)};pluginFacade.send=function(a,b){a=a||"",b=b||{},b.header="BROWSER >>>> SOCKET (PLUGIN)",isPluginAvailable()?(debug(a,b),globalVars.pluginObject.sendMessage("sendXml",{xml:a},"")):debug("failed to send message:`"+a+"` to the plugin")};var PluginCall=function(a,b,c,d){this.dn=c,this.direction=b,this.callId=a,this.status={call:null,video_remote:"start",video_local:"start",sound:null,record:"stop"},this.videoProfile=Rtcc.videoProfile,this.terminated=!1;var e,f=globalVars.webRtcUi,g=!1,h=function(a,b,c,d){d&&(c+="<appid>"+d+"</appid>"),modeFacade.send("<controlcall id='"+a+"'><"+b+">"+c+"</"+b+"></controlcall>")},i=function(b,c){var d="";c&&(d="<p>"+c+"</p>"),modeFacade.send('<controlcall id="'+a+'"><conference>'+b+d+"</conference></controlcall>")},j=new Vent;bindObjectToVent(this,j),this.getDirection=function(){return"out"===b?"outgoing":"incoming"},this.lockActiveSpeaker=function(a){i.call(this,"lockas",a)},this.unlockActiveSpeaker=function(){i.call(this,"unlockas")},this.turnOffActiveSpeaker=function(){i.call(this,"turnoffas")},this.sendInbandMessage=function(a){modeFacade.send("<sendinband>"+a.encodeHTML()+"</sendinband>")},this.turnOnActiveSpeaker=function(){modeFacade.send('<controlcall id="'+this.callId+'"><conference>turnonas</conference></controlcall>')},this.setWindowSize=function(mode){weemo.isPluginEmbeded()?f.setWindowSize(mode):modeFacade.send("<controlcall id='"+this.callId+"'><windowsize>"+mode+"</windowsize></controlcall>")},this.callPointer=function(mode){modeFacade.send("<controlcall id='"+this.callId+"'><callpointer mode='"+mode+"'></callpointer></controlcall>")},this.clearCallPointer=function(){modeFacade.send("<controlcall id='"+this.callId+"'><callpointer>clear</callpointer></controlcall>")},this.sharePointer=function(mode){modeFacade.send("<controlcall id='"+this.callId+"'><sharepointer mode='"+mode+"'></sharepointer></controlcall>")},this._updateVideoProfile=function(a){var b;b=a===this.videoProfile.THUMBNAIL||a===this.videoProfile.SMALL?1:2,modeFacade.send('<set videoprofile="'+b+'"/>')},this.updateSentVideoProfile=function(a){var b='<controlcall id="'+this.callId+'"><video_local>'+a+"</video_local></controlcall>";modeFacade.send(b)},this.requestRemoteVideoProfile=function(a){var b='<controlcall id="'+this.callId+'"><video_remote>'+a+"</video_remote></controlcall>";modeFacade.send(b)},this.dropAllAttendees=function(){weemo.requests.run("drop_all_attendees",[this])},this.confControl={kick:function(a){i("drop",a)},mute:function(a){i("mute",a)},unmute:function(a){i("unmute",a)},deafen:function(a){i("deafen",a)},undeafen:function(a){i("undeafen",a)},muteAll:function(){i("muteall")},unmuteAll:function(){i("unmute")},deafenAll:function(){i("deafen")},undeafenAll:function(){i("undeafen")},lock:function(){i("lock")},unlock:function(){i("unlock")},shareSendRequest:function(){i("sharesendrequest")},shareLockRelease:function(){i("sharelockrelease")}},this.clearSharePointer=function(){modeFacade.send("<controlcall id='"+this.callId+"'><sharepointer>clear</sharepointer></controlcall>")},this.accept=function(){h(this.callId,"call","start")},this.updateVideoProfile=function(a){debug("`call.updateVideoProfile` depreciated, please use `call.requestRemoteVideoProfile`"),this.requestRemoteVideoProfile(a)},this.acceptNoVideo=function(){h(this.callId,"call","start_novideo")},this.hangup=function(){this.terminated||(h(this.callId,"call","stop"),d.plugin&&f.hangup())},this.recordPause=function(){h(this.callId,"record","pause")},this.recordResume=function(){h(this.callId,"record","resume")},this.recordBookmark=function(){h(this.callId,"record","bookmark")},this.recordStop=function(){h(this.callId,"record","stop")},this.recordStart=function(a,mode){var b="";mode&&(b="mode='"+mode+"'"),modeFacade.send("<controlcall id='"+this.callId+"' url='"+a+"' "+b+"><record>start</record></controlcall>")},this.videoStart=function(){h(this.callId,"video_local","start"),d.plugin&&f.enableLocalVideo()},this.videoStop=function(){h(this.callId,"video_local","stop"),d.plugin&&f.disableLocalVideo()};var k=function(a){return a?"<filename>"+a+"</filename>":""};this.shareSave=function(a){modeFacade.send("<controlcall id='"+this.callId+"'><share_remote>save"+k(a)+"</share_remote></controlcall>")},this.shareSavePdf=function(a){modeFacade.send("<controlcall id='"+this.callId+"'><share_remote>savepdf"+k(a)+"</share_remote></controlcall>")},this.startRemoteControl=function(){h(this.callId,"share_remote","startrac")},this.stopRemoteControl=function(){h(this.callId,"share_remote","stoprac")},this.shareSaveJs=function(){h(this.callId,"share_remote","savejs")},this.videoSaveJs=function(){h(this.callId,"video_remote","savejs")},this.videoSave=function(a){modeFacade.send("<controlcall id='"+this.callId+"'><video_remote>save"+k(a)+"</video_remote></controlcall>")},this.videoSavePdf=function(a){modeFacade.send("<controlcall id='"+this.callId+"'><video_remote>savepdf"+k(a)+"</video_remote></controlcall>")},this.audioMute=function(){h(this.callId,"sound","mute"),d.plugin&&f.audioMute()},this.audioUnMute=function(){h(this.callId,"sound","unmute"),d.plugin&&f.audioUnMute()},this.settings=function(){h(this.callId,"settings","show")},this.shareStart=function(a){h(this.callId,"share_local","start",a)},this.shareList=function(){h(this.callId,"share_local","list")},this.shareStop=function(){h(this.callId,"share_local","stop")},this.pip=function(){h(this.callId,"pip","show"),d.plugin&&f.pip()},this.noPip=function(){h(this.callId,"pip","hide"),d.plugin&&f.noPip()},this.enableFrameSizeDetection=function(){g=!0,e&&(j.trigger("video.framesize",e),e=!1)},this._updateCallStatus=function(a){switch(a.type){case"datachannel":"ok"===a.status&&j.trigger("inband.message.ready");break;case"call":a.sipCallId&&(this.sipCallId=a.sipCallId);var b=a.status;"terminated"===a.status?(this.status=a.reason,d.plugin&&f.hangup()):"active"===a.status&&d.plugin&&f.acceptCall(),j.trigger(statusCallEventName(b),this.status);break;case"frame_size":g?j.trigger("video.framesize",clone(a)):e=clone(a);break;case"video_local":this.status.video_local=a.status,j.trigger("video.local."+a.status);break;case"video_remote":this.status.video_remote=a.status,j.trigger("video.remote."+a.status);break;case"sound":this.status.sound=a.status,j.trigger("sound."+a.status);break;case"record":this.status.record=a.status,a.filename?j.trigger("record."+a.status,a.filename):a.reason?j.trigger("record."+a.status,a.reason):j.trigger("record."+a.status);break;case"share_local":j.trigger("share.local."+a.status);break;case"share_remote":j.trigger("share.remote."+a.status);break;case"video_profile_request":j.trigger("video.profile.request",a.status)}var c;a.conference&&a.conference.participantsStatus&&j.trigger("conference.status",a.conference.participantsStatus),a.conference&&a.conference.participantList?(c={type:"participant_list",status:a.conference.participantList},j.trigger("conference.participants",a.conference.participantList)):a.conference&&a.conference.floor?(c={type:"participant_order",status:a.conference.floor},j.trigger("conference.participants.order",a.conference.floor)):c={type:a.type,status:a.status},a.reason&&(c.reason=a.reason),run_client_callback(weemo,"onCallHandler",[this,c])}},WebrtcCall=function(a,b,c,d){function e(){C=new WebrtcCall.VideoFrameSize(F.peer.getStats.bind(F.peer),B,F)}function f(a){WebrtcCall.helper.defaultErrorHandling(a),F.isOutgoing?g():w.hangup()}function g(){if(D&&D.endCall(),F.peer){var a=F.peer.getLocalStreams()[0];if(a){var b=a.getAudioTracks();b[0]&&b[0].stop();for(var c=a.getVideoTracks(),d=0;d<c.length;d++)c[d].stop();a.active=!1}try{F.peer.close()}catch(e){debug("Tried to close peer connection when it was already closed.")}}K.tabCaptureRunning&&K.tabCaptureStop(),K.destroy(),L.hangup()}function h(a){var b={cmd:"updatemedia",args:[w.callId,"candidate",a]};modeFacade.send(b)}function i(){var a={cmd:"controlcall",args:[w.callId,"start",F.peer.localDescription]};modeFacade.send(a)}function j(){var a=getPeerConnectionConfig(modeFacade.turn);F.peer=new RTCPeerConnection(a,{mandatory:[{googIPv6:!1}]}),F.peer.onicecandidate=I.onIceCandidate,F.peer.onaddstream=t,F.peer.onremovestream=u,F.peer.oniceconnectionstatechange=s,F.peer.onsignalingstatechange=function(){debug("Signaling state changed to "+F.peer.signalingState)},F.isOutgoing?(rtccDataChannel=F.peer.createDataChannel("rtccDataChannel",{reliable:!1}),J.setChannel(rtccDataChannel)):F.peer.ondatachannel=function(a){J.setChannel(a.channel)}}function k(){return"completed"===F.peer.iceConnectionState||"connected"===F.peer.iceConnectionState}function l(){if(k()){var a={sdp:F.peer.localDescription.sdp,type:F.peer.localDescription.type},b=K.trackId;if(b){var c=new RegExp(" "+b,"g"),d=new RegExp(b,"g");a.sdp=a.sdp.replace(c,"slides slidestrack"),a.sdp=a.sdp.replace(d,"slidestrack")}var e={cmd:"updatemedia",args:[w.callId,"full",a]};modeFacade.send(e)}}function m(a){x("onLocalDescription: "+a);var b=new WebrtcCall.SdpManager(a.sdp);"offer"===a.type&&b.setDirection(H.getDirection()),a.sdp=b.getSdp(),F.peer.setLocalDescription(a,l,WebrtcCall.helper.defaultErrorHandling)}function n(){x("setRemoteDescription SUCCESS");var a;if(F.peer.remoteDescription){var b=sdpParser.parseSDP(F.peer.remoteDescription.sdp);a=WebrtcCall.helper.getSDPVideoMedia(b)}H.setMediaVideo(a),"offer"===F.peer.remoteDescription.type&&(F.createAnswer(m),F.callActive&&H.triggerEventsRemote(G))}function o(){run_client_callback(weemo,"onCallHandler",[w,{type:"webRTCcall",status:F.status.call}]),B.trigger("active"),run_client_callback(weemo,"onCallHandler",[w,{type:"sound",status:F.status.sound}]),B.trigger("sound."+F.status.sound),run_client_callback(weemo,"onCallHandler",[w,{type:"video_remote",status:H.getVideoRemoteStatusText()}]),B.trigger("video.remote."+H.getVideoRemoteStatusText()),run_client_callback(weemo,"onCallHandler",[w,{type:"video_local",status:H.getVideoLocalStatusText()}]),B.trigger("video.local."+H.getVideoLocalStatusText())}function p(){for(var a=0;a<I.candidates.length;a++)h(I.candidates[a]);F.callActive||(D=new WebrtcCall.Stats(F.peer,w.callId,F),L.acceptCall(F.getLocalStream(),F.remoteStream,H.localWantToSendVideo,H.remoteWantToSendVideo),q(),L.setRemoteStream(F.remoteStream)),F.status.call="active",F.callActive=!0,o(),z.reach("callActive").tryRun(),A.reach("callActive").tryRun()}function q(){if(G){for(var a=[],b=0;b<G.passiveSpeakers.length;b++)G.passiveSpeakers[b].src&&(a[b]={src:G.passiveSpeakers[b].videoDisabled?!1:G.passiveSpeakers[b].src,displayName:G.passiveSpeakers[b].dn});L.setPassiveVideoBoxes(a)}}function r(a){D&&(D.mainIncomingVideoStreamId=a)}function s(a){debug("onIceConnectionState "+F.peer.iceConnectionState),("completed"===F.peer.iceConnectionState||"connected"===F.peer.iceConnectionState)&&y.reach("iceConnected").tryRun()}function t(a){function b(){L.setRemoteStream(c)}x("OnAddStream");var c=a.stream,d=c.getVideoTracks();if(c.id===K.remoteTrackId)debug("Adding incoming screen sharing stream"),B.trigger("share.remote.start",c);else if(w.isConference){if(c.id===G.activeSpeakerId)F.remoteStream=c,d.length>0&&(F.mainIncomingVideoStreamId=d[0].id,r(F.mainIncomingVideoStreamId)),L.setRemoteStream(c),c.onaddtrack=b;else for(var e=0;e<G.passiveSpeakers.length;e++)if(c.id===G.passiveSpeakers[e].id){G.passiveSpeakers[e].src=window.URL.createObjectURL(c);break}}else F.remoteStream=c,L.setRemoteStream(c),c.onaddtrack=b,d.length>0&&(F.mainIncomingVideoStreamId=d[0].id,r(F.mainIncomingVideoStreamId));q()}function u(a){var b=a.stream;K.remoteTrackId&&b.id===K.remoteTrackId&&(debug("Removing incoming screen sharing stream"),B.trigger("share.remote.stop")),b.id!=G.activeSpeakerId&&q()}function v(a){x("gotStream: \n"+a),run_client_callback(weemo,"onCallHandler",[w,{type:"rtccUserMediaAccepted"}]),B.trigger("webrtc.mediarequest.success");var b=F.peer.getLocalStreams()[0],c=a.getVideoTracks();if(a.getAudioTracks().length>0){F.peer.addStream(a);var d=a.getVideoTracks();d.length>0&&(F.mainOutgoingVideoStreamId=d[0].id)}else b&&c.length>0&&("Screen"===c[0].label&&(c[0].onended=w.shareStop,K.trackId=c[0].id,B.trigger("share.local.start")),b.addTrack(c[0]));G&&G.waitThumbStream(a,navigator.getUserMedia,v,f)||(F.isEstablished()||F.initiateSdpOffer(m,n),F.callActive&&(L.setLocalStream(b),L.enableLocalVideo(),D&&D.videoStart(),F.createOffer(m)))}var w=this;w.isConference=b[5]||d.defaultCallIsConf;var x=WebrtcCall.helper.log,y=new StateManager(["callActiveReceived","iceConnected"],p,!0),z=new StateManager(["pListReceived","callActive"]),A=new StateManager(["startDetection","callActive"],e),B=new Vent;bindObjectToVent(this,B);var C,D,E=new WebrtcCall.VideoConfig(w.isConference),F=new WebrtcCall.Connection(B,b[3]),G=w.isConference?new WebrtcCall.Conference(F,E):!1,H=new WebrtcCall.VideoDirection(this,B,F,globalVars.webRtcUi),I=new WebrtcCall.IceCandidateManager(F,H,i,h),J=new WebrtcCall.InbandChannel(this),K=new WebrtcCall.ScreenShare(B,F,v,m,J),L=globalVars.webRtcUi;b[3]&&(this.callerRef=b[3].ref),this.sipCallId=b[4],this.callId=a,this.dn=c,w.videoProfile=E.profiles,this.getConnection=function(){return F},this.getDirection=F.getCallDirection,this.settings=function(){debug("Not available in webRTC"),run_client_callback(weemo,"onCallHandler",["notUseInThisMode",null]),B.trigger("error.unavailable","settings")},this.enableFrameSizeDetection=function(){C||A.reach("startDetection").tryRun()},this.audioMute=function(){F.peer.getLocalStreams()[0].getAudioTracks()[0].enabled=!1,F.status.sound="mute",L.audioMute(),run_client_callback(weemo,"onCallHandler",[this,{type:"sound",status:F.status.sound}]),B.trigger("sound.mute")},this.setWindowSize=function(a){L.setWindowSize(a)},this.audioUnMute=function(){F.peer.getLocalStreams()[0].getAudioTracks()[0].enabled=!0,F.status.sound="unmute",L.audioUnMute(),run_client_callback(weemo,"onCallHandler",[this,{type:"sound",status:F.status.sound}]),B.trigger("sound.unmute")},this.pip=L.pip,this.noPip=L.noPip,this.clean=function(){g(),C&&C.destroy()},this.updateVideoProfile=function(a){debug("`call.updateVideoProfile` depreciated, please use `call.requestRemoteVideoProfile`"),this.requestRemoteVideoProfile(a)},this.requestRemoteVideoProfile=function(a){var b={cmd:"updatevideoprofile",args:[w.callId,a]};modeFacade.send(b)},this.hangup=function(){msg={cmd:"controlcall",args:[w.callId,"stop"]},modeFacade.send(msg)},this._updateCallStatus=function(a){switch(a.type){case"active":y.reach("callActiveReceived").tryRun();break;case"terminated":run_client_callback(weemo,"onCallHandler",[w,{type:"webRTCcall",status:"terminated",reason:a.reason}]),B.trigger("terminate",a.reason),this.clean();break;case"proceeding":run_client_callback(weemo,"onCallHandler",[w,{type:"webRTCcall",status:"proceeding"}]),B.trigger("proceeding")}};var M=function(a){L.setParticipantList(a)};this._updateParticipantList=function(a){z.setCallback(M.bind(this,a)),z.reach("pListReceived").tryRun(),B.trigger("conference.participants",a)},this.sendInbandMessage=J.send,this._updateMedia=function(a){if(x("onUpdateMedia"),"full"==a[1]){var b=new RTCSessionDescription(a[2]);x(b);var c=new WebrtcCall.SdpManager(b.sdp),d=c.parseAsRemote({isConference:this.isConference,remoteSharingTrackId:K.remoteTrackId,passiveSpeakers:G.passiveSpeakers});K.remoteTrackId=d.remoteSharingTrackId,G.passiveSpeakers=d.passiveSpeakers,G.activeSpeakerId=d.activeSpeakerId,G.activeVideoPassiveSpeakers=d.activeVideoPassiveSpeakers,G&&q(),F.peer.setRemoteDescription(b,n,WebrtcCall.helper.defaultErrorHandling)}else{var e=new RTCIceCandidate(a[2]);F.peer.addIceCandidate(e,function(){x("addIceCandidate, success")},WebrtcCall.helper.defaultErrorHandling)}},this.updateSentVideoProfile=function(a){x("onUpdateVideoProfile");var b=E.getConstraints(a),c=F.peer.getLocalStreams()[0],d=c.getVideoTracks()[0];d&&(d.stop(),c.removeTrack(d),navigator.getUserMedia(b,v,WebrtcCall.helper.defaultErrorHandling))},this._updateVideoProfile=function(a){debug("`call._updateVideoProfile` is depreciated, please use call.updateSentVideoProfile"),this.updateSentVideoProfile(a)};this.confControl=J.confControl,this.lockActiveSpeaker=function(a){this.confControl.lockActiveSpeaker(a)},this.unlockActiveSpeaker=function(){this.confControl.unlockActiveSpeaker()},this.turnOffActiveSpeaker=function(){this.confControl.turnOffActiveSpeaker()},this.turnOnActiveSpeaker=function(){this.confControl.turnOnActiveSpeaker()},this.recordStart=this.confControl.recordStart,this.recordStop=this.confControl.recordStop,this.recordPause=this.confControl.recordPause,this.recordResume=this.confControl.recordResume,this.recordBookmark=this.confControl.recordBookmark;var N=function(a){a=a||{};var b=a.video;a.video!==!1&&(b=E.defaultVideoOptions);var c={video:b,audio:{optional:[{sourceId:globalVars.audioInputDeviceId}]}};run_client_callback(weemo,"onCallHandler",[w,{type:"rtccUserMediaRequest",status:c}]),B.trigger("webrtc.mediarequest",c),j(),F.isOutgoing&&(L.ringing(w,!0),run_client_callback(weemo,"onCallHandler",[w,{type:"webRTCcall",status:"outgoing"
}]),B.trigger("outgoing")),navigator.getUserMedia(c,v,function(a){run_client_callback(weemo,"onCallHandler",[w,{type:"rtccUserMediaError",status:a}]),B.trigger("error",a),B.trigger("webrtc.mediarequest.error",a),f(a)})};this.acceptNoVideo=function(){H.localWantToSendVideo=!1,N({video:!1})},this.accept=function(){N()},this.videoStart=function(){if(H.localWantToSendVideo)debug("video already started");else{H.localWantToSendVideo=!0,run_client_callback(weemo,"onCallHandler",[this,{type:"video_local",status:H.getVideoLocalStatusText()}]),B.trigger("video.local.start");var a={video:!0,audio:!1};run_client_callback(weemo,"onCallHandler",[w,{type:"rtccUserMediaRequest",status:a}]),B.trigger("webrtc.mediarequest",a),navigator.getUserMedia({video:E.defaultVideoOptions,audio:!1},v,f)}},this.videoStop=function(){H.localWantToSendVideo&&(H.localWantToSendVideo=!1,F.stopTracks(),G&&G.stopTracks(),D&&D.videoStop(),run_client_callback(weemo,"onCallHandler",[this,{type:"video_local",status:H.getVideoLocalStatusText()}]),B.trigger("video.local.stop"),L.disableLocalVideo()),F.createOffer(m)},this.shareStart=K.shareStart,this.shareStop=K.shareStop,this.sendTabcaptureParameters=function(){var a=getPeerConnectionConfig(modeFacade.turn);window.postMessage({type:"FROM_RTCC_PAGE",message:{type:"RTCCCONFIG",value:a}},"*")},F.isOutgoing||(msg={cmd:"statuscall",args:[w.callId,"call","proceeding"]},modeFacade.send(msg),L.ringing(w,!1),run_client_callback(weemo,"onCallHandler",[w,{type:"webRTCcall",status:"incoming"}]))};WebrtcCall.Conference=function(a,b){var c=this;c.activeSpeakerId=!1,c.passiveSpeakers=[],c.activeVideoPassiveSpeakers=[];var d=!1;c.stopTracks=function(){d=!1},c.waitThumbStream=function(a,c,e,f){return!d&&(d=!0,a.getVideoTracks().length>0)?(c(b.constraintsThumb,e,f),!0):!1}},WebrtcCall.Connection=function(a,b){function c(a){return!(!a||""===a.sdp)}var d=this;d.peer=!1,d.callActive=!1,d.startupRemoteDescription=b,d.isOutgoing=""===b,d.remoteStream=!1,d.mainOutgoingVideoStreamId=!1,d.mainIncomingVideoStreamId=!1,d.status={call:null,sound:null},d.createAnswer=function(a){d.peer.createAnswer(a,debug,{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},d.createOffer=function(a){d.peer.createOffer(a,debug,{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},d.getLocalStream=function(){return d.peer.getLocalStreams()[0]},d.getCallDirection=function(){return d.isOutgoing?"outgoing":"incoming"},d.isEstablished=function(){return c(d.peer.remoteDescription)},d.initiateSdpOffer=function(a,b){""===d.startupRemoteDescription?d.createOffer(a):d.peer.setRemoteDescription(new RTCSessionDescription(d.startupRemoteDescription),b,WebrtcCall.helper.defaultErrorHandling)},d.stopTracks=function(){for(var a=d.getLocalStream(),b=a.getVideoTracks(),c=0;c<b.length;c++)b[c].stop(),a.removeTrack(b[c])}},WebrtcCall.IceCandidateManager=function(a,b,c,d,e){function f(){i.sdpSent=!0,c()}function g(b){i.sdpSent?a.callActive?(debug("updateMedia"),d(b.candidate)):i.candidates.push(b.candidate):i.shouldSendSDP(b)&&(clearTimeout(j),j=setTimeout(f,e.iceTimeout))}function h(){i.sdpSent||(clearTimeout(j),f())}var i=this;e=e={},e.iceTimeout=e.iceTimeout||300,i.sdpSent=!1,i.candidates=[];var j,k=!1,l=!1;i.onIceCandidate=function(a){a.candidate?(debug("Local ICE candidate: \n"+a.candidate),g(a)):(debug("END OF CANDIDATES"),h())},i.shouldSendSDP=function(a){return"audio"==a.candidate.sdpMid?k=!0:"video"==a.candidate.sdpMid&&(l=!0),k&&(!b.localWantToSendVideo||l)}},WebrtcCall.InbandChannel=function(a){var b,c,d,e=this,f=!1,g=function(a){return{uid:a.uid,id:a.pid,displayName:a.displayname,status:a.status}},h=function(b){try{var c,e=JSON.parse(b.data);if("conferencecontrol"===e.cmd){if("welcome"===e.type)a.myPid=e.pid,a.isAdmin=e.admin;else if("floorchange"===e.type)a.trigger("conference.participants.order",e.list);else if("recordingstarted"===e.type)a.trigger("record.start",e.filename);else if("recordingstopped"===e.type)a.trigger("record.stop",e.reason);else if("sharelocked"===e.type)a.trigger("share.lock",e.pid);else if("sharestarted"===e.type)a.myPid!==e.pid?a.trigger("share.remote.start",e.pid):a.trigger("share.local.start");else if("sharestopped"===e.type)a.myPid!==e.pid?a.trigger("share.remote.stop",e.pid):a.trigger("share.local.stop");else if("participantlist"===e.type){for(d={participants:[]},c=0;c<e.participants.length;c++){var f=e.participants[c];d.participants.push(g(f)),f.admin&&(d.hostId=f.pid)}a._updateParticipantList(d)}else if("participantstatuschange"===e.type){for(c=0;c<e.participants.length;c++)for(var h=g(e.participants[c]),i=0;i<d.participants.length;i++)if(d.participants[i].id===h.id){d.participants[i]=h;break}a._updateParticipantList(d)}return debug_options={header:"MVS >>>>> JS"},debug(b.data,debug_options),!0}}catch(j){}return!1};e.setChannel=function(d){b=d,b.onmessage=function(b){h(b)||(f?c(b.data):(run_client_callback(weemo,"onInbandMessageReceived",[b.data]),apiEvents.trigger("message.inband",b.data),a.trigger("inband.message.receive",b.data)))},b.onopen=function(){a.trigger("inband.message.ready")}},e.setScreenshareExtChannel=function(a){c=a},e.enableRedirectToExtension=function(){f=!0},e.disableRedirectToExtension=function(){f=!1},this.confControl={kick:function(a){e.send_json({cmd:"conferencecontrol",type:"kick",participant:a})},mute:function(a){e.send_json({cmd:"conferencecontrol",type:"mute",participant:a})},unmute:function(a){e.send_json({cmd:"conferencecontrol",type:"unmute",participant:a})},deafen:function(a){e.send_json({cmd:"conferencecontrol",type:"deafen",participant:a})},undeafen:function(a){e.send_json({cmd:"conferencecontrol",type:"undeafen",participant:a})},muteAll:function(){e.send_json({cmd:"conferencecontrol",type:"muteall"})},unmuteAll:function(){e.send_json({cmd:"conferencecontrol",type:"unmuteall"})},lockActiveSpeaker:function(a){e.send_json({cmd:"conferencecontrol",type:"lockas",participant:a})},turnOffActiveSpeaker:function(){e.send_json({cmd:"conferencecontrol",type:"turnoffas"})},turnOnActiveSpeaker:function(){e.send_json({cmd:"conferencecontrol",type:"turnonas"})},unlockActiveSpeaker:function(a){e.send_json({cmd:"conferencecontrol",type:"unlockas",participant:a})},deafenAll:function(){e.send_json({cmd:"conferencecontrol",type:"deafenall"})},undeafenAll:function(){e.send_json({cmd:"conferencecontrol",type:"undeafenall"})},lock:function(){e.send_json({cmd:"conferencecontrol",type:"lock"})},unlock:function(){e.send_json({cmd:"conferencecontrol",type:"unlock"})},shareSendRequest:function(){e.send_json({cmd:"conferencecontrol",type:"requestsharelock"})},shareLockRelease:function(){e.send_json({cmd:"conferencecontrol",type:"releasesharelock"})},recordStart:function(a,mode){e.send_json({cmd:"conferencecontrol",type:"recordingstart",url:a,streams:mode})},recordStop:function(){e.send_json({cmd:"conferencecontrol",type:"recordingstop"})},recordPause:function(){e.send_json({cmd:"conferencecontrol",type:"recordingpause"})},recordResume:function(){e.send_json({cmd:"conferencecontrol",type:"recordingresume"})},recordBookmark:function(){e.send_json({cmd:"conferencecontrol",type:"recordingbookmark"})}},this.send_json=function(a){this.send(JSON.stringify(a))},this.send=function(a){b&&"open"===b.readyState?(debug("sending inband message:"+a),b.send(a)):debug("cannot send message `"+a+"`, inband message not established")}},WebrtcCall.ScreenShare=function(a,b,c,d,e){function f(a){window.postMessage({type:"FROM_RTCC_PAGE",message:{type:"inband",value:a}},"*")}function g(a){navigator.getUserMedia({audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxHeight:screen.height,maxWidth:screen.width,chromeMediaSourceId:a,maxFrameRate:4}}},c,debug)}function h(a){if(a.source==window&&"FROM_RTCC_EXT"===a.data.type){var b=a.data.content;if("rtccGotDesktopMedia"===b.type){if(!b.content)return void debug("Desktop capture: Access denied");g(b.content)}else"tabCaptureSdp"===b.type?(e.send("RTCCSDP"+b.value),e.enableRedirectToExtension(),i.tabCaptureRunning=!0):"tabCaptureStop"===b.type&&(e.disableRedirectToExtension(),i.tabCaptureRunning=!1)}}var i=this;i.trackId=!1,i.remoteTrackId=!1,i.tabCaptureRunning=!1,e.setScreenshareExtChannel(f),i.shareStart=function(){return weemo.isShareExtensionLoaded()?void window.postMessage({type:"FROM_RTCC_PAGE",content:{type:"rtccChooseDesktopMedia",content:""}},"*"):void a.trigger("chrome.screenshare.missing",globalVars.screenShareExtentionUrl)},i.shareStop=function(){var c=b.getLocalStream();if(!c)return void debug("shareStop: No localStream.");var e=c.getVideoTracks();if(!e)return void debug("shareStop: No Video Track");var f=arrayFilter(e,function(a){return"Screen"===a.label});if(0===f.length)return void debug("shareStop: no share track");var g=f[0];"ended"===g.readyState?(i.trackId="",c.removeTrack(g),b.createOffer(d),a.trigger("share.local.stop")):g.stop()},i.tabCaptureStop=function(){i.tabCaptureRunning&&window.postMessage({type:"FROM_RTCC_PAGE",message:{type:"RTCCTABCAPTURESTOP",content:""}},"*")},i.destroy=function(){window.removeEventListener("message",h)},window.addEventListener("message",h)},WebrtcCall.SdpManager=function(a){"use strict";function b(a,b,c,d){function e(a){return function(b){return a===b.id}}var f,g=arrayFilter(a,function(a){return-1!=a.value.search("ssrc:"+b.id+" x-display-name")}),h=arrayFilter(d,e(c));return h[0]&&(f=h[0].src),{dn:g[0].value.split('"')[1],id:c,src:f,videoDisabled:-1!==g[0].value.search("x-disabled")}}function c(a,b,c){return d(a,0,-1,b,c)}function d(a,b,c,d,e){for(var f=-1!==c?c:a.length,g=b;f>g;++g)if(0===a[g].indexOf(d)&&(!e||-1!==a[g].toLowerCase().indexOf(e.toLowerCase())))return g}var e=this;e.getSdp=function(){return a},e.parseAsRemote=function(c){for(var d,e,f=c.remoteSharingTrackId||!1,g=!1,h=[],i=[],j=WebrtcCall.helper.getSDPVideoMedia(sdpParser.parseSDP(a)),k=0;k<j.length;k++)for(var l=arrayFilter(j[k].ssrcs||[],function(a){return"msid"===a.attribute}),m=0;m<l.length;m++){var n=l[m];if(d=n.value.split(" ")[0],e=n.value.split(" ")[1],"slidestrack"===e)f=d;else if(c.isConference)if(g===!1)g=d;else if(j[k].invalid){var o=b(j[k].invalid,n,d,c.passiveSpeakers);o.videoDisabled===!1&&i.push(o),h.push(o)}}return{passiveSpeakers:h,activeSpeakerId:g,remoteSharingTrackId:f,activeVideoPassiveSpeakers:i}},e.setDirection=function(b){var f=a.split("\r\n"),g=c(f,"m=","video");if(g){var h,i=d(f,g+1,-1,"m=")||f.length;objectForEach(WebrtcCall.VideoDirection.directions,function(a,b){h||(h=d(f,g+1,i,"a="+b))}),h&&(f[h]="a="+b,a=f.join("\r\n"))}return e}},WebrtcCall.Stats=function(a,b,c){function d(){l={voutwidth:[],voutheight:[],voutrr:[],voutgrab:[],vinwidth:[],vinheight:[],vinrr:[],vinlp:"",vinjit:"",ainlp:"",inbw:[],outbw:[],aindp:"",video_on:m,video_off:n,sharing_out_on:0,remote_candidate_type:!1,sharing_out_off:1}}function e(a){return 7===p||a?(p=1,!0):!1}function f(a,b,c){var d=h(a,c),e=h(b,c);return d===!1||e===!1?"":d+"x"+e}function g(a,b){var c=h(a,b);return c===!1?"":c}function h(a,b){return 0===a.length?!1:b.apply(null,a)}function i(a,b,c){function d(a){if(0===a.length)return"";var b=a.reduce(function(a,b){return a+b},0),c=b/a.length;return c}var e;c?e="end":o===!1?(e="start",o=!0):e="update";var h=[b,e],i=[];i.push(f(a.voutwidth,a.voutheight,Math.min)),i.push(f(a.voutwidth,a.voutheight,Math.max)),h.push(i);var j=[];j.push(g(a.voutrr,Math.min)),j.push(g(a.voutrr,Math.max)),j.push(d(a.voutrr)),h.push(j);var k=[];k.push(g(a.voutgrab,Math.min)),k.push(g(a.voutgrab,Math.max)),k.push(d(a.voutgrab)),h.push(k);var l=[];l.push(f(a.vinwidth,a.vinheight,Math.min)),l.push(f(a.vinwidth,a.vinheight,Math.max)),h.push(l);var m=[];m.push(g(a.vinrr,Math.min)),m.push(g(a.vinrr,Math.max)),m.push(d(a.vinrr)),h.push(m),h.push(["","",""]),h.push(["","",""]),h.push(["","",""]);var n=[];n.push(g(a.inbw,Math.min)),n.push(g(a.inbw,Math.max)),n.push(d(a.inbw)),h.push(n);var p=[];return n.push(g(a.outbw,Math.min)),n.push(g(a.outbw,Math.max)),n.push(d(a.outbw)),h.push(p),h.push(["","",""]),h.push(a.video_on),h.push(a.video_off),h.push(0),h.push(1),h.push(a.remote_candidate_type),{cmd:"callreport",args:h}}function j(c){c=c||{};var f=c.end_report||!1,g=this;p++,a.getStats(function(a){for(var c,h,m,n,o=0;o<a.result().length;o++)if("googCandidatePair"===a.result()[o].type){if("true"==a.result()[o].stat("googActiveConnection")){var p=a.result()[o].stat("googRemoteCandidateType");switch(p){case"local":l.remote_candidate_type="host";break;case"stun":l.remote_candidate_type="serverreflexive";break;case"relay":l.remote_candidate_type="relayed";break;default:l.remote_candidate_type=p}}}else"ssrc"===a.result()[o].type?""!==a.result()[o].stat("googFrameHeightSent")&&g.mainOutgoingVideoStreamId===a.result()[o].stat("googTrackId")?(l.voutwidth.push(Number(a.result()[o].stat("googFrameWidthSent"))),l.voutheight.push(Number(a.result()[o].stat("googFrameHeightSent"))),l.voutrr.push(Number(a.result()[o].stat("googFrameRateSent"))),l.voutgrab.push(Number(a.result()[o].stat("googFrameRateInput"))),n=Number(a.result()[o].stat("bytesSent"))):""!==a.result()[o].stat("googFrameHeightReceived")&&g.mainIncomingVideoStreamId===a.result()[o].stat("googTrackId")?(l.vinwidth.push(Number(a.result()[o].stat("googFrameWidthReceived"))),l.vinheight.push(Number(a.result()[o].stat("googFrameHeightReceived"))),l.vinrr.push(Number(a.result()[o].stat("googFrameRateReceived"))),h=Number(a.result()[o].stat("bytesReceived"))):""!==a.result()[o].stat("audioOutputLevel")?c=Number(a.result()[o].stat("bytesReceived")):""!==a.result()[o].stat("audioInputLevel")&&(m=Number(a.result()[o].stat("bytesSent"))):"VideoBwe"===a.result()[o].type&&debug("Outgoing video bandwidth: "+a.result()[o].stat("googTransmitBitrate")+" bps",{show_on_debug_level:2});var q=r.calculate(c,h);q&&l.inbw.push(q);var t=s.calculate(m,n);if(t&&(l.outbw.push(t),debug("Outgoing total bandwidth: "+t+" bps",{show_on_debug_level:2})),e(f)){var u=i(l,b,f);modeFacade.send(u,{show_on_debug_level:2}),d()}f||(k=setTimeout(function(){j.call(g)},1e4))})}var k,l,m=1,n=0,o=!1,p=0;this.mainOutgoingVideoStreamId=c.mainOutgoingVideoStreamId,this.mainIncomingVideoStreamId=c.mainIncomingVideoStreamId,this.endCall=function(){clearTimeout(k),j.call(this,{end_report:!0})},this.videoStop=function(){m=0,n=1},this.videoStart=function(){m=1,n=0};var q=function(){var a,b=0;this.calculate=function(c,d){var e,f,g=d||0,h=new Date;return a&&(f=h-a,e=c+g-b),a=h,b=c+g,e?8*e/f:!1}},r=new q,s=new q;d();var t=this;k=setTimeout(function(){j.call(t)},1e4)},WebrtcCall.VideoConfig=function(a){var b=this;b.profiles=Rtcc.videoProfile;var c={},d={maxFrameRate:8};"Android"!==global_config.os&&(c.minAspectRatio=1.777,c.maxAspectRatio=1.778,d.minAspectRatio=1.777,d.maxAspectRatio=1.778);var e={};e[b.profiles.THUMBNAIL]=[{sourceId:globalVars.videoInputDeviceId},{maxWidth:160},{maxHeight:90}],e[b.profiles.SMALL]=[{sourceId:globalVars.videoInputDeviceId},{maxWidth:320},{maxHeight:180}],e[b.profiles.MEDIUM]=[{sourceId:globalVars.videoInputDeviceId},{minWidth:640},{minHeight:360},{maxWidth:640},{maxHeight:360},{minFrameRate:20}],e[b.profiles.MEDIUM_HIGH]=[{sourceId:globalVars.videoInputDeviceId},{minWidth:854},{minHeight:480}],e[b.profiles.HIGH]=[{sourceId:globalVars.videoInputDeviceId},{minWidth:1280},{minHeight:720}],b.defaultVideoOptions={mandatory:c},b.constraintsThumb={audio:!1,video:{mandatory:d}},"Android"!==global_config.os&&(b.defaultVideoOptions.optional=e[a?b.profiles.MEDIUM:b.profiles.SMALL],b.constraintsThumb.video.optional=e[b.profiles.THUMBNAIL]),debug("defaultVideoOptions :"+JSON.stringify(b.defaultVideoOptions)),debug("constraintsThumb :"+JSON.stringify(b.constraintsThumb)),b.getConstraints=function(a){var b={audio:!1,video:{mandatory:c}};return"Android"!==global_config.os&&(b.video.optional=e[a]),debug("getConstraints :"+JSON.stringify(b)),b}},WebrtcCall.VideoDirection=function(a,b,c,d){function e(a){if("inactive"===a||"recvonly"===a)return!1;if("sendonly"===a||"sendrecv"===a)return!0;throw new Error("Unknown video direction: "+a)}function f(a){var b="sendrecv";return a&&a[0]&&a[0].direction&&(b=a[0].direction),b}function g(a){a?j.remoteWantToSendVideo=!0:j.remoteWantToSendVideo=!1}var h,i,j=this;j.remoteWantToSendVideo=!0,j.localWantToSendVideo=!0,j.setMediaVideo=function(a){h=a,i=f(h),j.remoteWantToSendVideo=e(i)},j.triggerEventsRemote=function(c){c&&0===c.activeVideoPassiveSpeakers.length?d.disableRemoteVideo():c?d.enableRemoteVideo():j.remoteWantToSendVideo?d.enableRemoteVideo():d.disableRemoteVideo(),run_client_callback(weemo,"onCallHandler",[a,{type:"video_remote",status:j.getVideoRemoteStatusText()}]),b.trigger("video.remote."+j.getVideoRemoteStatusText())},j.getVideoRemoteStatusText=function(){return j.remoteWantToSendVideo?"start":"stop"},j.getVideoLocalStatusText=function(){return j.localWantToSendVideo?"start":"stop"},j.getDirection=function(){var a="sendrecv";return j.localWantToSendVideo&&!j.remoteWantToSendVideo?a="sendonly":!j.localWantToSendVideo&&j.remoteWantToSendVideo?a="recvonly":j.localWantToSendVideo||j.remoteWantToSendVideo||(a="inactive"),a},j.getMethodsToTest=function(){return{isSendingVideo:e,getMediaDirection:f,updateRemoteStatus:g}}},WebrtcCall.VideoDirection.directions={INACTIVE:"inactive",RECVONLY:"recvonly",SENDONLY:"sendonly",SENDRECV:"sendrecv"},WebrtcCall.VideoFrameSize=function(a,b,c,d){function e(a){for(var b=[],c=0;c<a.result().length;c++)"ssrc"===a.result()[c].type&&b.push(a.result()[c]);return b}function f(a){for(var b=e(a),d={},f=0;f<b.length;f++)c.mainIncomingVideoStreamId===b[f].stat("googTrackId")&&""!==b[f].stat("googFrameHeightReceived")&&(d.width=Number(b[f].stat("googFrameWidthReceived")),d.height=Number(b[f].stat("googFrameHeightReceived")));return d}d=d||1e3;var g={height:void 0,width:void 0};!function h(){a(function(a){var c=f(a);(c.width!=g.width||c.height!=g.height)&&(g=c,b.trigger("video.framesize",clone(g))),timeoutid=setTimeout(h,d)})}(),this.destroy=function(){clearTimeout(timeoutid)}},WebrtcCall.helper={},WebrtcCall.helper.getSDPVideoMedia=function(a){return arrayFilter(a.media,function(a){return"video"===a.type})},WebrtcCall.helper.log=function(a){debug(a,{show_on_debug_level:2})},WebrtcCall.helper.defaultErrorHandling=debug;var ClientCallRequest=function(a){this.uid=a,this.status="pending",this.accept=function(){this.status="accepted",weemo.requests.run("client_call_request",["accept",this.uid])},this.decline=function(){this.status="declined",weemo.requests.run("client_call_request",["decline",this.uid])}},downloadPlugin=function(){run_client_callback(this,"onVideoPluginNotInstalled",[global_config.downloadUrl]),apiEvents.trigger("plugin.missing",globalVars.downloadUrl)},get_global_config_defaults=function(a){return{debugLevel:0,platform:navigator.platform,version:a.version,max_skynet_request_size:10,standAlone:!1,extensionWaitTime:2e3,force:!1,webpUri:"ws://188.165.163.148:80",pluginMode:Rtcc.pluginMode.EMBEDDED,downloadUrl:a.downloadUrl,endpointUrl:a.endpointUrl,forceNotWebRtcCompliant:!1,forceWebRtcCompliant:!1,forcePluginStatus:void 0,hap_url:["https://hap1.rtccloud.net/rtcc","https://hap2.rtccloud.net/rtcc"],current_hap:0,callObjects:{},non_uid_ids_for_sending_messages:[],hap:"prod/",meetingPointBeingCreated:!1,connection_attempts_before_not_started_cb:3,messageTimeout:1e4,bypassTurnProbeTest:!1,probeProtocol:"wss",webpProtocol:"wss",force_chrome_allows_plugin:!1,forceIsChrome:!1,sixDigitNoCall:!1,buttonDisabled:{mute:!1,video:!1,share:!1},iceConfig:["turn:[turn_candidate]:3478?transport=udp","turn:[turn_candidate]:3478?transport=tcp"],turn_probing_timeout:3e3,timeBetweenConnectionAttempts:6e3,pollingTimeout:2e4,interval_to_check_socket_closed:1e3,uiUrl:a.uiBaseUrl+"RtccUi.js",uiVersion:!1,webp_timeout:5e3,webp_timebetweenpings:1e4,displayName:void 0,mode_parameter:a.mode_parameter}},globalVars={state:Rtcc.STATES.NOT_CONNECTED_TO_FACADE,presence_state:Rtcc.PRESENCE_STATES.NOK,token:null,call:!1,audioInputDeviceId:"",videoInputDeviceId:"",messageEventListeners:[],sixDigitsCallMode:!1,force_connect:!1,downloadUrl:"https://download.rtccloud.net/plugin/release/3",timeout:{pluginConnect:!1,pluginSetCallback:!1,pluginDetection:!1},screenShareExtentionUrl:"https://chrome.google.com/webstore/detail/screen-sharing/obcglfamidbohlfjlcfdajopagnhkgoo"},weemo=this,joinRequestNotifications={},Attendee=function(a,b,c){this.id=a,this.uid=b,this.displayName=c,this.status="waitingForApproval",this.accept=function(){return weemo.requests.run("control_meeting_point",[this.id,"accept",this.uid])},this.timestamp=void 0,this.deny=function(){return weemo.requests.run("control_meeting_point",[this.id,"deny",this.uid])}},JoinRequestNotification=function(a){this.id=a.id,this.uid=a.uid,this.timestamp=a.timestamp,this.displayName=a.displayName,this.deny=function(){weemo.requests.run("control_meeting_point",[this.id,"deny",this.uid])}},DoInclude={include:function(a){if(!a.include)return a;a.include instanceof Array!=!0&&(a.include=[a.include]);var b=a.include.slice(0);for(delete a.include;b.length>0;){var c=b.shift();if(!shared[c])throw new Error("object "+c+" does not exist");a=Rtcc.merge(shared[c],a)}return this.include(a)}},Request=function(a){this.delegates=a||{}};Request.prototype.getDelegate=function(a,b){return"function"==typeof this.delegates[a]?this.delegates[a]:!1},Request.prototype.notAllowed=function(){var a=this.getDelegate("notAllowed");a?a.call(this.delegates):debug("the command "+this.name+" is not allowed in this state")},Request.prototype.allowed=function(){var a=this.getDelegate("allowed");return a?a.call(this.delegates):!0},Request.prototype.run=function(){return this.allowed()?"function"!=typeof this.delegates.run?(debug("the command "+this.name+" is missing a run function"),!1):this.delegates.run.apply(this.delegates,arguments)||!0:(this.notAllowed(),!1)};var RequestManager=function(a){var a=a||{},b=a.requests||{};this.getRequests=function(){return b},this.setRequests=function(a){var a=clone(a);b=this.preProcessRequests(Object.keys(a),a),debug("requests for "+this.name+" have been successfully loaded")}};RequestManager.prototype=Rtcc.merge(RequestManager.prototype,DoInclude),RequestManager.prototype.preProcessRequests=function(a,b){return this.process(a,b,this.preProcessRequest)},RequestManager.prototype.preProcessRequest=function(a,b){var c=this.include(b),d=new Request(c);d.name=a;var e={};return e[a]=d,e},RequestManager.prototype.process=function(a,b,c){if(0===a.length)return{};var d=a.shift(),e=b[d];return Rtcc.merge(c.call(this,d,e),this.process(a,b,c))},RequestManager.prototype.getRequest=function(a){var b=this.getRequests(),c=this;return b[a]?b[a]:{run:function(){debug("attempted to run request "+a+", however this request does not exist for mode "+c.name)}}},RequestManager.prototype.broadcast=function(a,b){var c=function(c,d){return d[a].apply(d,b)};this.process(Object.keys(this.getRequests()),this.getRequests(),c)},RequestManager.prototype.runAll=function(){return this.broadcast("run",Array.prototype.slice.call(arguments,0))},RequestManager.prototype.run=function(a,b){if(b instanceof Array==!1&&void 0!==b)throw new Error("Second parameter of run can only be undefined and an array");var c=this.getRequest(a);return void 0===b?c.run.apply(c):c.run.apply(c,b)};var ResponseManager=function(a,b){this.handlers=b,a=a||{},this.parsers=[],this.setParsers(a)};ResponseManager.prototype=Rtcc.merge(ResponseManager.prototype,DoInclude),ResponseManager.prototype.setParsers=function(a){this._setParsers(clone(a))},ResponseManager.prototype._setParsers=function(a){this.parsers=[],a.preprocessor&&(this.preprocessor=a.preprocessor.execute);for(var b=Object.keys(a),c=0;c<b.length;c++)if("preprocessor"!==b[c]){var d=this.include(a[b[c]]),e=Rtcc.merge({name:b[c]},d);this.parsers.push(e)}},ResponseManager.prototype.parse=function(a){if(0===this.parsers.length)throw new Error("Parsers not set; use responseManager.setParsers");for(var b,c=this.parsers.slice(0);c.length>0&&void 0===b;){var d=c.shift();try{b=d.parse(a)}catch(e){debug("parser "+d.name+" produced an error when trying to parse the string:"+a),debug(e.stack)}}return void 0!==b&&(b=[d.name,b]),b},ResponseManager.prototype.doPreProcess=function(a){if("function"==typeof this.preprocessor)try{return this.preprocessor(a)}catch(b){debug("an error occured running the preprosesor function on "+a)}return a},ResponseManager.prototype.handle=function(a){debug(a,{header:"SOCKET >>>> BROWSER"});var b=this.doPreProcess(a);if(b&&(parsed_data=this.parse(b),void 0!==parsed_data)){if(debug("message "+a+"parsed by parser "+parsed_data[0],{show_on_debug_level:2}),!this.handlers[parsed_data[0]])return debug("no shared handler for "+parsed_data[0]),!0;try{return this.handlers[parsed_data[0]].handle.call(this.handlers[parsed_data[0]],parsed_data[1]),!0}catch(c){debug("the handler "+parsed_data[0]+" produced an error "),debug(c.stack)}return!1}};var plugin_requests={attend_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a){var b="<attendmeetingpoint><meetingpointid>"+a+"</meetingpointid></attendmeetingpoint>";modeFacade.send(b)}},broadcast_message:{include:["allowed_after_presence_ok"],run:function(a,b,c){debug("broadcast_message not yet supported in driver mode")}},call_created:{run:function(a){var b=global_config.callObjects,c=global_config.calledContact;if("-1"!==a.createdCallId){var d=new PluginCall(a.createdCallId,a.direction,a.displayNameToCall,global_config);globalVars.call=d,d.sipCallId=a.sipCallId,a.callerRef&&(d.callerRef=a.callerRef),b[a.createdCallId]=d,d.status.sound="unmute","out"===a.direction?(c===a.displayNameToCall?(d.status.call="createdCall",run_client_callback(weemo,"onCallHandler",[d,{type:"call",status:d.status.call}]),debug(d),start_in_audio_only?(start_in_audio_only=!1,d.acceptNoVideo()):d.accept()):debug("called contact does not match displayNameToCall"),global_config.calledContact="",global_config.plugin&&globalVars.webRtcUi.ringing(d,!0)):(d.status.call="incoming",run_client_callback(weemo,"onCallHandler",[d,{type:"call",status:"incoming"}]),global_config.plugin&&globalVars.webRtcUi.ringing(d,!1)),apiEvents.trigger("call.create",d)}else debug("call has negative id")}},cancel_agent_request:{include:["allowed_after_presence_ok"],run:function(){modeFacade.send("<acdcancel></acdcancel>")}},clear_toasts:{run:function(){modeFacade.send("<cleartoasts></cleartoasts>")}},client_call_request:{include:["allowed_after_presence_ok"],run:function(a,b){switch(a){case"accept":modeFacade.send("<acdaccept>"+b+"</acdaccept>");break;case"decline":modeFacade.send("<acddecline>"+b+"</acddecline>")}}},connect_to_cloud:{include:"allowed_after_connected",run:function(a){modeFacade.send("<connect hap='"+a+"'></connect>")}},control_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a,b,c){message="<controlmeetingpoint><meetingpointid>"+a+"</meetingpointid><action>"+b+"</action>",c&&(message+="<uid>"+c+"</uid>"),message+="</controlmeetingpoint>",modeFacade.send(message)}},coredump:{run:function(){modeFacade.send("<coredump></coredump>")}},create_call:{include:"allowed_after_sip_ok",run:function(a,b){var c=global_config.displayName;global_config.hap;start_in_audio_only=b,c?a.uidToCall&&a.type&&a.displayNameToCall?(global_config.calledContact=a.displayNameToCall,debug("Uid called : "+a.uidToCall),modeFacade.send("<createcall uid='"+a.uidToCall+"' displayname='"+a.displayNameToCall+"' type='"+a.type+"'></createcall>")):debug("uidToCall, type and displayNameToCall must be set"):(debug("caller displayName must be set"),run_client_callback(weemo,"onConnectionHandler",["error",16]),apiEvents.trigger("error",16))}},create_meeting_point:{include:["allowed_after_verified_user_ok","xml_utils"],run:function(a){var b="<createmeetingpoint><type>"+a.conftype+"</type>";b+=this.buildXmlArgs.call(a),b+="</createmeetingpoint>",modeFacade.send(b)}},create_six_digits:{include:"allowed_after_sip_ok",run:function(a,b,c){var d="";c&&(d=' mpi="'+c+'"'),modeFacade.send('<createsixdigits mode="'+a+'"'+d+">"+b+"</createsixdigits>")}},delete_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a){var b="<deletemeetingpoint><meetingpointid>"+a+"</meetingpointid></deletemeetingpoint>";modeFacade.send(b)}},delete_six_digits:{include:"allowed_after_sip_ok",run:function(){modeFacade.send("<deletesixdigits></deletesixdigits>")}},drop_all_attendees:{include:"allowed_after_verified_user_ok",run:function(a){modeFacade.send('<controlcall id="'+a.callId+'"><conference>dropallattendees</conference></controlcall>')}},get_call_window_default_position:{run:function(){modeFacade.send('<get type="callwindowdefaultposition" />')}},get_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a){var b="<getmeetingpoint><meetingpointid>"+a+"</meetingpointid></getmeetingpoint>";modeFacade.send(b)}},get_myref:{run:function(){modeFacade.send('<get type="myref"/>')}},get_permanent_meeting_point_by_uid:{include:"allowed_after_verified_user_ok",run:function(a){modeFacade.send("<getpermanentmeetingpoint><uid>"+a+"</uid></getpermanentmeetingpoint>")}},get_presence:{include:["chunckable","allowed_after_presence_ok","roster_xml_builder"],run:function(a){if(!(a instanceof Array))throw"expects an array";var b=this.getNextChunk(a,global_config.max_skynet_request_size);b.next&&modeFacade.send(this.toXml("presenceget",b.next)),b.remainder&&this.run(b.remainder)}},get_roster:{include:"allowed_after_presence_ok",run:function(){modeFacade.send("<rosterget></rosterget>")}},get_stats:{include:"allowed_after_sip_ok",run:function(){modeFacade.send("<getstats/>")}},get_status:{include:"allowed_after_sip_ok",run:function(a){modeFacade.send("<get type='status' uid='"+a+"' />")}},get_version:{run:function(){modeFacade.send("<get type='version'></get>")}},get_wait_list:{include:["allowed_after_presence_ok"],run:function(){modeFacade.send("<acdgetwaitinglist></acdgetwaitinglist>")}},get_wall_settings:{include:"allowed_after_verified_user_ok",run:function(){modeFacade.send("<getwall/>")}},getperipherals:{run:function(){modeFacade.send("<getperipherals/>")}},host_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a,mode){var b="";void 0!==mode&&(b=' mode="'+mode+'"');var c="<hostmeetingpoint"+b+"><meetingpointid>"+a+"</meetingpointid></hostmeetingpoint>";modeFacade.send(c)}},modify_meeting_point:{include:["allowed_after_verified_user_ok","xml_utils"],run:function(a,b){var c="<modifymeetingpoint><meetingpointid>"+a.id+"</meetingpointid><type>"+a.conftype+"</type>";c+=this.buildXmlArgs.call(a,b),c+="</modifymeetingpoint>",modeFacade.send(c)}},request_agent:{include:["allowed_after_presence_ok"],run:function(a){modeFacade.send("<acdgetsingleuser><mask>"+a.mask+"</mask><value>"+a.value+"</value></acdgetsingleuser>")}},request_agent_list:{include:["allowed_after_presence_ok"],run:function(a){modeFacade.send("<acdgetuserlist><mask>"+a.mask+"</mask><value>"+a.value+"</value></acdgetuserlist>")}},reset:{run:function(){modeFacade.getConnectionMode()===Rtcc.connectionModes.DRIVER?modeFacade.send("<reset></reset>"):debug("reset disabled in driver mode")}},roster_add:{include:["chunckable","allowed_after_presence_ok","roster_xml_builder"],run:function(a){if(!(a instanceof Array))throw"expects an array";var b=this.getNextChunk(a,global_config.max_skynet_request_size);b.next&&modeFacade.send(this.toXml("rosteradd",b.next)),b.remainder&&this.run(b.remainder)}},roster_clear:{include:"allowed_after_presence_ok",run:function(){modeFacade.send("<rosterclear></rosterclear>")}},roster_remove:{include:["chunckable","allowed_after_presence_ok","roster_xml_builder"],run:function(a){if(!(a instanceof Array))throw"expects an array";var b=this.getNextChunk(a,global_config.max_skynet_request_size);b.next&&modeFacade.send(this.toXml("rosterremove",b.next)),b.remainder&&this.run(b.remainder)}},send_acknowledge:{include:["allowed_after_presence_ok"],run:function(a,b,c){var d='<messageack to="'+b+'" id="'+a+'">'+c+"</messageack>";modeFacade.send(d)}},send_data_channel_message:{include:"allowed_after_sip_ok",run:function(a,b){var c=strToUTF8Arr(b),d="a"+base64EncArr(c);
arrayContains(global_config.non_uid_ids_for_sending_messages,Number(a))?modeFacade.send("<reply to='"+a+"'>"+d+"</reply>"):modeFacade.send("<message to='"+a+"'>"+d+"</message>")}},send_display_name:{include:"allowed_after_verified_user_ok",run:function(a){modeFacade.send("<set displayname='"+a.encodeHTML()+"'></set>")}},send_inband_message:{include:"allowed_after_sip_ok",run:function(a){modeFacade.send("<sendinband>"+a.encodeHTML()+"</sendinband>")}},send_message:{include:["allowed_after_presence_ok"],run:function(a,b,c){var d='<presencemessage to="'+b+'" id="'+a+'">'+c.encodeHTML()+"</presencemessage>";modeFacade.send(d)}},set_auto_erase_threshold:{include:"allowed_after_sip_ok",run:function(a){var b;if(b=Number(a),isNaN(b)||0>b||b>1e3)throw new Error("auto_erase_threshold expects values between 0 and 10000");modeFacade.send('<set autoerasethr="'+b+'"/>')}},set_call_window_default_position:{run:function(a){modeFacade.send('<set callwindowdefaultposition="'+a+'"></set>')}},set_dead_party:{include:"allowed_after_sip_ok",run:function(a){modeFacade.send('<set deadparty="'+a+'"/>')}},set_disabled_buttons:{castOption:function(a){return a===!0?"1":"0"},makeBinaryRepresentation:function(a){var b="";return b+=this.castOption(a.mute),b+=this.castOption(a.video),b+=this.castOption(a.share)},run:function(a){global_config.buttonDisabled=Rtcc.merge(global_config.buttonDisabled,a);var b=this.makeBinaryRepresentation(global_config.buttonDisabled),c=parseInt(b.split("").reverse().join(""),2);modeFacade.send('<set disabledbuttons="'+c+'"/>')}},set_ice_mode:{include:"allowed_after_sip_ok",run:function(a){modeFacade.send("<set icemode='"+a+"'></set>")}},set_js_api_version_to_plugin:{run:function(a){modeFacade.send('<set version="'+a+'" />')}},set_my_acd_presence:{include:"allowed_after_presence_ok",run:function(a){modeFacade.send("<acdpresenceset>"+a+"</acdpresenceset>")}},set_my_acd_priority:{run:function(a){modeFacade.send("<acdpriorityset>"+a+"</acdpriorityset>")}},set_my_presence:{include:["allowed_after_presence_ok","my_presence_validate_input"],run:function(a){this.validateInput(a),modeFacade.send("<presenceset>"+a+"</presenceset>")}},set_overlay:{run:function(mode){modeFacade.send('<set overlay="'+mode+'"/>')}},set_peripherals:{run:function(a){var b="";if(void 0!==a.audio_capture&&(b+="<audiocap>"+a.audio_capture+"</audiocap>"),void 0!==a.audio_playback&&(b+="<audioplay>"+a.audio_playback+"</audioplay>"),void 0!==a.video_capture&&(b+="<videocap>"+a.video_capture+"</videocap>"),""===b)throw new Error("cannot pass empty value");b="<setperipherals>"+b+"</setperipherals>",modeFacade.send(b)}},set_pickup_mode:{include:"allowed_after_sip_ok",run:function(a){modeFacade.send('<set pickupmode="'+a+'"/>')}},set_plugin_mode:{run:function(mode){global_config.pluginMode=mode,modeFacade.send('<set pluginmode="'+mode+'"/>'),apiEvents.trigger("plugin.mode."+mode)}},set_send_to_top_interval:{include:"allowed_after_sip_ok",run:function(a){modeFacade.send('<set automosttop="'+a+'"/>')}},set_startup_profile:{include:"allowed_after_sip_ok",run:function(a){modeFacade.send('<set startupprofile="'+a+'"/>')}},set_startup_size:{include:"allowed_after_sip_ok",run:function(a){weemo.isPluginEmbeded()?globalVars.webRtcUi.setStartupSize(a):modeFacade.send('<set startupsize="'+a+'"/>')}},set_test_mode:{run:function(mode){modeFacade.send('<set testmode="'+ +mode+'"/>')}},set_url_referer:{run:function(a){modeFacade.send('<set urlreferer="'+a+'" />')}},set_user_agent:{run:function(){modeFacade.send('<set ua="'+global_config.browser+" "+global_config.browserVersion+'"/>')}},set_wide_height:{run:function(a){if(!a||360>=a||isNaN(Number(a)))throw new Error("integer greater or equal to 360 expected");modeFacade.send('<set wideheight="'+a+'"/>')}},sip_register:{run:function(){debug("request not implemented in mode driver")}},toast:{run:function(a){if(void 0===a.type)throw new Error("param `type` is required");if("message"!==a.type&&"info"!==a.type&&"warning"!==a.type)throw new Error("type `"+a.type+"` does not exist, allowed types are `info`, `message` and `warning`");if(void 0===a.message)throw new Error("param `message` is required");if("message"===a.type&&void 0===a.from)throw new Error("param `from` is required for toast of type `message`");void 0===a.timeout&&(a.timeout=5);var b=" ";"message"===a.type&&(b=' from="'+a.from+'" '),modeFacade.send('<toast type="'+a.type+'"'+b+'timeout="'+a.timeout+'">'+a.message+"</toast>")}},update_wall_settings:{include:"allowed_after_verified_user_ok",run:function(a){var b="";objectForEach(a,function(a,c){void 0!==c&&(b+="<"+a+">"+c.encodeHTML()+"</"+a+">")}),modeFacade.send("<updatewall>"+b+"</updatewall>")}},verify_user:{run:function(a){run_client_callback(weemo,"onConnectionHandler",["connectedRtccDriver",0]),apiEvents.trigger("client.connect",weemo.getConnectionMode());var b=globalVars.token,c=globalVars.force_connect,d=global_config.appId,e=global_config.rtccUserType,f="";c===!0?f=" force='1'":"bypass"===a?f=" bypass='1'":"external"===e&&(e="ls_external",f=" suffix='"+generateSuffix()+"'"),modeFacade.send("<verifyuser token='"+b+"' urlreferer='"+d+"' type='"+e+"'"+f+"></verifyuser>"),globalVars.force_connect=!1}}},webrtc_requests={attend_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a){var b={cmd:"attendmeetingpoint",args:[a]};modeFacade.send(b)}},broadcast_message:{include:["allowed_after_presence_ok"],run:function(a,b,c){modeFacade.send({cmd:"dc_multiple_send",args:[a,b,c]})}},call_created:{run:function(a){var b=a[0],c=Number(a[1]),d=a[2],e=new WebrtcCall(c,a,d,global_config);globalVars.call=e;var f=e.getConnection();f.status.sound="unmute","out"===b&&(debug(e),start_in_audio_only?(start_in_audio_only=!1,e.acceptNoVideo()):e.accept()),global_config.callObjects[c]=e,apiEvents.trigger("call.create",e)}},cancel_agent_request:{include:["allowed_after_presence_ok"],run:function(){modeFacade.send({cmd:"acd_cancelwait",args:[]})}},client_call_request:{include:["allowed_after_presence_ok"],run:function(a,b){modeFacade.send({cmd:"acd_request",args:[a,b]})}},control_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a,b,c){var d={cmd:"controlmeetingpoint",args:[a,b]};return c&&d.args.push(c),modeFacade.send(d),d}},coredump:{run:function(){debug("request not implemented in mode webrtc")}},create_call:{include:"allowed_after_sip_ok",run:function(a,b){start_in_audio_only=b;var c={cmd:"createcall",args:[a.uidToCall,a.displayNameToCall,a.type]};modeFacade.send(c)}},create_meeting_point:{include:["allowed_after_verified_user_ok","json_utils"],run:function(a){var b={cmd:"createmeetingpoint",args:this.buildJsonArgs.call(a,[a.conftype])};return modeFacade.send(b),b}},create_six_digits:{include:"allowed_after_sip_ok",run:function(mode,a,b){var c={mode:mode,display_name:a};b&&(c.mpi=b),modeFacade.send({cmd:"createsixdigits",args:c})}},delete_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a){var b={cmd:"deletemeetingpoint",args:[a]};modeFacade.send(b)}},delete_six_digits:{include:"allowed_after_sip_ok",run:function(){modeFacade.send({cmd:"deletesixdigits",args:{}})}},drop_all_attendees:{include:"allowed_after_verified_user_ok",run:function(){debug("request not implemented in mode webrtc")}},get_call_window_default_position:{run:function(){debug("request not implemented in mode webrtc"),run_client_callback(weemo,"onConnectionHandler",["notUseInThisMode",0]),apiEvents.trigger("error.unavailable")}},get_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a){message={cmd:"getmeetingpoint",args:[a]},modeFacade.send(message)}},get_myref:{run:function(){modeFacade.send({cmd:"get",args:["myref"]})}},get_permanent_meeting_point_by_uid:{include:"allowed_after_verified_user_ok",run:function(a){modeFacade.send({cmd:"getpermanentmeetingpoint",args:[a]})}},get_presence:{include:["chunckable","allowed_after_presence_ok"],run:function(a){this._run(a.slice(0))},_run:function(a){if(!(a instanceof Array))throw"expects an array";var b=this.getNextChunk(a,global_config.max_skynet_request_size);b.next&&modeFacade.send({cmd:"presence_get",args:b.next}),b.remainder&&this._run(b.remainder)}},get_roster:{include:"allowed_after_presence_ok",run:function(){modeFacade.send({cmd:"presence_getwholeroster",args:[]})}},get_status:{include:"allowed_after_sip_ok",run:function(a){var b={cmd:"get",args:["status",a]};modeFacade.send(b)}},get_version:{run:function(){debug("request not implemented in mode webrtc")}},get_wait_list:{include:["allowed_after_presence_ok"],run:function(){modeFacade.send({cmd:"acd_getwaitingqueue",args:[]})}},get_wall_settings:{include:"allowed_after_verified_user_ok",run:function(){modeFacade.send({cmd:"getwall",args:[]})}},getperipherals:{constraints:{audio:{deviceId:""},video:{deviceId:""}},enumerateDevices:function(){return navigator.mediaDevices.enumerateDevices()},getUserMedia:function(){return navigator.mediaDevices.getUserMedia(this.constraints)},translateItem:function(a){return{id:a.deviceId,name:a.label}},selectDevice:function(a,b,c){return""===c&&0===b.length||c===a.id},run:function(){var a=this;return new Promise(function(b){a.getUserMedia().then(function(){return a.enumerateDevices()}).then(function(c){var d={audio_capture:[],audio_playback:[],video_capture:[]};c.map(function(b){var c=a.translateItem(b);switch(b.kind){case"audioinput":a.selectDevice(c,d.audio_capture,globalVars.audioInputDeviceId)?(c.selected=!0,globalVars.audioInputDeviceId=c.id):c.selected=!1,d.audio_capture.push(c);break;case"audiooutput":d.audio_playback.push(c);break;case"videoinput":a.selectDevice(c,d.video_capture,globalVars.videoInputDeviceId)?(c.selected=!0,globalVars.videoInputDeviceId=c.id):c.selected=!1,d.video_capture.push(c)}}),apiEvents.trigger("media.devices",d),b(d)})})}},host_meeting_point:{include:"allowed_after_verified_user_ok",run:function(a,mode){mode=mode||Rtcc.callType.N_TO_N;var b={cmd:"hostmeetingpoint",args:[a,mode]};modeFacade.send(b)}},modify_meeting_point:{include:["allowed_after_verified_user_ok","json_utils"],run:function(a,b){var c={cmd:"modifymeetingpoint",args:this.buildJsonArgs.call(a,[a.id],b)};modeFacade.send(c)}},request_agent:{include:"allowed_after_presence_ok",run:function(a){modeFacade.send({cmd:"acd_getsingleuser",args:[a.mask,a.value]})}},request_agent_list:{include:"allowed_after_presence_ok",run:function(a){modeFacade.send({cmd:"acd_getuserlist",args:[a.mask,a.value]})}},reset:{run:function(){weemo.disconnect()}},roster_add:{include:["chunckable","allowed_after_presence_ok"],run:function(a){if(!(a instanceof Array))throw"expects an array";var b=this.getNextChunk(a,global_config.max_skynet_request_size);b.next&&modeFacade.send({cmd:"roster_add",args:b.next}),b.remainder&&this.run(b.remainder)}},roster_clear:{include:"allowed_after_presence_ok",run:function(){modeFacade.send({cmd:"roster_clear",args:[]})}},roster_remove:{include:["chunckable","allowed_after_presence_ok"],run:function(a){if(!(a instanceof Array))throw"expects an array";var b=this.getNextChunk(a,global_config.max_skynet_request_size);b.next&&modeFacade.send({cmd:"roster_remove",args:b.next}),b.remainder&&this.run(b.remainder)}},send_acknowledge:{include:["allowed_after_presence_ok"],run:function(a,b,c){modeFacade.send({cmd:"dc_acksend",args:[a,b,c]})}},send_data_channel_message:{include:"allowed_after_sip_ok",run:function(a,b){var c=strToUTF8Arr(b),d="a"+base64EncArr(c);arrayContains(global_config.non_uid_ids_for_sending_messages,Number(a))?modeFacade.send({cmd:"message_reply",args:[a,d]}):modeFacade.send({cmd:"message",args:[a,d]})}},send_display_name:{include:"allowed_after_verified_user_ok",run:function(a){var b={cmd:"set",args:["displayname",a]};modeFacade.send(b)}},send_inband_message:{run:function(a){webRtcChannelWrapper.send(a)}},send_message:{include:["allowed_after_presence_ok"],run:function(a,b,c){modeFacade.send({cmd:"dc_send",args:[a,b,c]})}},set_call_window_default_position:{run:function(){debug("request not implemented in mode webrtc"),run_client_callback(weemo,"onConnectionHandler",["notUseInThisMode",0]),apiEvents.trigger("error.unavailable","setCallWindowDefaultPosition")}},set_disabled_buttons:{include:"allowed_after_sip_ok",run:function(){debug("request not implemented in mode webrtc")}},set_ice_mode:{run:function(){debug("request not implemented in mode webrtc")}},set_my_acd_presence:{include:"allowed_after_presence_ok",run:function(a){modeFacade.send({cmd:"acd_presence_set",args:[a]})}},set_my_acd_priority:{run:function(){debug("request not implemented in mode webrtc")}},set_my_presence:{include:["allowed_after_presence_ok","my_presence_validate_input"],run:function(a){this.validateInput(a),modeFacade.send({cmd:"presence_set",args:[a]})}},set_peripherals:{run:function(a){void 0!==a.audio_capture&&(globalVars.audioInputDeviceId=a.audio_capture),void 0!==a.video_capture&&(globalVars.videoInputDeviceId=a.video_capture);var b={audio:{deviceId:globalVars.audioInputDeviceId},video:{deviceId:globalVars.videoInputDeviceId}};return navigator.mediaDevices.getUserMedia(b)}},set_pickup_mode:{run:function(){debug("request not implemented in mode webrtc")}},set_startup_profile:{include:"allowed_after_sip_ok",run:function(a){global_config.webRtcUi.setStartupSize(a)}},set_startup_size:{include:"allowed_after_sip_ok",run:function(a){debug("setStartupSize "+a),globalVars.webRtcUi.setStartupSize(a)}},set_test_mode:{run:function(){debug("request not implemented in mode webrtc")}},set_url_referer:{run:function(){debug("request not implemented in mode webrtc")}},set_wide_height:{run:function(){debug("request not implemented in mode webrtc")}},sip_register:{run:function(){modeFacade.send({cmd:"sip_register",args:[]})}},update_wall_settings:{include:"allowed_after_verified_user_ok",run:function(a){modeFacade.send({cmd:"updatewall",args:[a]})}},verify_user:{run:function(a){if("bypass"===a)return void debug("bypass not implemented in mode webrtc");global_config.standAlone?(run_client_callback(weemo,"onConnectionHandler",["connectedNoSip",0]),apiEvents.trigger("cloud.nosip.connect")):(run_client_callback(weemo,"onConnectionHandler",["connectedWebRTC",0]),apiEvents.trigger("client.connect",Rtcc.connectionModes.WEBRTC));var b=globalVars.token,c=global_config.appId,d=global_config.rtccUserType,e=global_config.platform,f="";f=null!==e.match(/mac/i)?"mac":null!==e.match(/win/i)?"pc":null!==e.match(/linux/i)?"linux":e;var g;g=global_config.standAlone?"standalone":"not_standalone";var h;h="external"===d?[c,b,"ls_external",f,g,generateSuffix()]:[c,b,d,f,g];var i={cmd:"verifyuser",args:h};modeFacade.send(i)}}},plugin_parsers={acknowledge_received:{parse:function(a){var b=a.getElementsByTagName("messageack")[0];if(b){var c={};return c.uid=b.getAttribute("from"),c.message_id=b.getAttribute("id"),c.status=b.childNodes[0].nodeValue,c}}},agent_or_queue_received:{convertPresencePayload:function(a){if(0===a.childNodes.length)return[];var b=a.childNodes[0];return a.removeChild(b),[{uid:b.childNodes[0].nodeValue,presence:b.getAttribute("presence")}].concat(this.convertPresencePayload(a))},parse:function(a){var b=a.getElementsByTagName("acduserlist")[0];if(b){var c={},d=b.getElementsByTagName("queue")[0];return d?c.queue={position:Number(d.childNodes[0].nodeValue),length:Number(d.getAttribute("len"))}:c={queue:{position:0,length:0},agents:{length:Number(b.getAttribute("len")),uid_array:this.convertPresencePayload(b)}},c}}},audio_receieved:{parse:function(a){var b=a.getElementsByTagName("status")[0];if(b){var c=b.getElementsByTagName("audio")[0];if(c)return"ok"===c.childNodes[0].nodeValue?"ok":"nok"}}},blob_received:{parse:function(a){var b=a.getElementsByTagName("blob")[0];if(b){var c={value:b.childNodes[0].nodeValue,current:Number(b.getAttribute("current")),total:Number(b.getAttribute("total")),type:b.getAttribute("type")};return c}}},call_audio_received:{parse:function(a){var b=a.getElementsByTagName("audioreceived")[0];return b?!0:void 0}},call_created:{parse:function(a){if(createdcall=a.getElementsByTagName("createdcall")[0],createdcall){var b={},c=createdcall.getElementsByTagName("sipcallid")[0];c&&(b.sipCallId=c.childNodes[0].nodeValue);var d=createdcall.getElementsByTagName("ref")[0];return d&&(b.callerRef=d.childNodes[0].nodeValue),b.createdCallId=createdcall.getAttribute("id"),b.direction=createdcall.getAttribute("direction"),b.displayNameToCall=createdcall.getAttribute("displayname"),b}}},call_status_received:{current_share_list:[],parse:function(a){statuscall=a.getElementsByTagName("statuscall")[0];var b;if(statuscall){var c={};c.id=statuscall.getAttribute("id");var d=statuscall.getElementsByTagName("sipcallid")[0];d&&(c.sipCallId=d.childNodes[0].nodeValue);var e=statuscall.getElementsByTagName("call")[0];if(e)return c.type="call",c.status=e.childNodes[0].nodeValue,"terminated"==c.status&&(b=statuscall.getElementsByTagName("reason")[0],c.reason=b.childNodes[0].nodeValue),c;var f=statuscall.getElementsByTagName("video_local")[0];if(f)return c.type="video_local",c.status=f.childNodes[0].nodeValue,c;var g=statuscall.getElementsByTagName("video_profile_request")[0];if(g)return c.type="video_profile_request",c.status=g.childNodes[0].nodeValue,c;var h=statuscall.getElementsByTagName("video_remote")[0];if(void 0!==h&&null!==h)return c.type="video_remote",c.status=h.childNodes[0].nodeValue,c;var i=statuscall.getElementsByTagName("share_local")[0];if(i)return c.type="share_local",c.status=i.childNodes[0].nodeValue,c;var j=statuscall.getElementsByTagName("share_remote")[0];if(j)return c.type="share_remote",c.status=j.childNodes[0].nodeValue,"stoprac"===c.status?c.status="remotecontrol.stop":"startrac"===c.status&&(c.status="remotecontrol.start"),c;var k=statuscall.getElementsByTagName("sound")[0];if(k)return c.type="sound",c.status=k.childNodes[0].nodeValue,c;var l=statuscall.getElementsByTagName("record")[0];if(l){c.type="record",c.status=l.childNodes[0].nodeValue;var m=statuscall.getElementsByTagName("filename")[0];return b=statuscall.getElementsByTagName("reason")[0],m&&(c.filename=m.childNodes[0].nodeValue),b&&(c.reason=b.childNodes[0].nodeValue),c}var n=statuscall.getElementsByTagName("share_list")[0];if(n){c.type="share_local_list",c.item_number=parseInt(n.getAttribute("nitems"),10);var o=statuscall.getElementsByTagName("app")[0];return c.item_id=o.getAttribute("id"),c.item_name=o.childNodes[0].nodeValue,c}var p=statuscall.getElementsByTagName("displayedwidth")[0],q=statuscall.getElementsByTagName("displayedheight")[0];if(q&&p){var r=statuscall.getElementsByTagName("decodedwidth")[0],s=statuscall.getElementsByTagName("decodedheight")[0];return c.type="frame_size",r&&s&&(c.decoded={},c.decoded.height=Number(s.childNodes[0].nodeValue),c.decoded.width=Number(r.childNodes[0].nodeValue)),c.displayed={},c.displayed.height=Number(q.childNodes[0].nodeValue),c.displayed.width=Number(p.childNodes[0].nodeValue),c}var t=statuscall.getElementsByTagName("datachannel")[0];if(t)return c.type="datachannel",c.status=t.getAttribute("status"),c;var u,v=JXON.xmlDoc2jsonObject(a).statuscall;if(v.conference){var w={},x={};if(v.id=v["@id"],delete v["@id"],v.conference.status){var y=[];for(isArray(v.conference.status.p)||(v.conference.status.p=[v.conference.status.p]),u=0;u<v.conference.status.p.length;u++){var z=v.conference.status.p[u];y.push({id:z.id,mute:"true"===z.mute,deaf:"true"===z.deaf,video:"true"===z.video})}w.participantsStatus=y}if(v.conference.floor)w.floor=v.conference.floor.p,isArray(w.floor)||(w.floor=[w.floor]);else if(v.conference.list){isArray(v.conference.list.p)||(v.conference.list.p=[v.conference.list.p]);var A=[];for(u=0;u<v.conference.list.p.length;u++){var B={id:v.conference.list.p[u].id};v.conference.list.p[u].n&&(B.displayName=v.conference.list.p[u].n),v.conference.list.p[u].uid&&(B.uid=v.conference.list.p[u].uid),A.push(B)}x.hostId=v.conference.host,x.myId=v.conference.mypid,x.participants=A,w.participantList=x}v.conference=w}return v}}},call_video_received:{parse:function(a){var b=a.getElementsByTagName("videoreceived")[0];if(b){return!0}}},client_call_requested:{parse:function(a){var b,c;return(b=a.getElementsByTagName("acdrequested")[0])?c={type:"requested",uid:b.childNodes[0].nodeValue}:(b=a.getElementsByTagName("acdcanceled")[0],b?c={type:"canceled",uid:b.childNodes[0].nodeValue}:void 0)}},conference_status:{parse:function(a){var b=a.getElementsByTagName("conference_status")[0];if(b);}},dropped_received:{parse:function(a){var b=a.getElementsByTagName("dropped")[0];return b?!0:void 0}},error_received:{include:"xml_utils",parse:function(a){if(a.firstChild&&"error"===a.firstChild.nodeName){var b=a.firstChild,c={};switch(b.childNodes[0]&&(c.message=b.childNodes[0].nodeValue),c.message){case"1":globalVars.state=Rtcc.STATES.CONNECTED_TO_FACADE,debug("Should Not Be used (err "+c.error+")");break;case"2":debug("Long poll: Wrong WebService init session (err "+c.error+")");break;case"3":debug("Should Not Be used (err "+c.error+")");break;case"4":debug("only connect, and coredump are allowed right after connection (err "+c.error+")");break;case"5":debug("XML command parsing error, or <connect> received with a different HAP setting, or unrecognized command in current WD state (err "+c.error+")");break;case"6":debug("Received command rejected, as the user is not yet authenticated in MAPI."+c.error+")");break;case"7":run_client_callback(weemo,"onConnectionHandler",["error",c.message]),apiEvents.trigger("error",c.message),response_handlers.sip_recieved.handle({status:"ko"});break;case"8":throw run_client_callback(weemo,"onConnectionHandler",["error",c.message]),apiEvents.trigger("error",c.message),debug("Cloud connection: Disconnected from the Cloud (err "+c.error+")"),"should not happen";default:var d="Error message : General error. Please contact support (err "+c.error+")";apiEvents.trigger("error",d),debug(d)}}}},get_result:{parse:function(a){var b=a.getElementsByTagName("get_result")[0];if(b);}},hold:{parse:function(a){var b=a.getElementsByTagName("hold")[0];return b?!0:void 0}},inband_received:{parse:function(a){var b=a.getElementsByTagName("inbandreceived")[0];return b?b.childNodes[0]?b.childNodes[0].nodeValue:"":void 0}},kicked_received:{parse:function(a){var b=a.getElementsByTagName("kicked")[0];if(b){var c={};return c.kickedName=b.getAttribute("displayname"),c.kickedUrl=b.getAttribute("urlreferer"),c}}},meeting_point_attended:{parse:function(a){var b=a.getElementsByTagName("meetingpointattended")[0];if(b){var c={},d=b.getAttribute("status");c.status=d;var e=b.getElementsByTagName("meetingpointid")[0];if(e&&(c.id=e.childNodes[0].nodeValue),"ok"===d){var f=b.getElementsByTagName("request")[0];if(void 0!==f&&null!==f&&(c.request=f.childNodes[0].nodeValue,"invited"===c.request)){var g=b.getElementsByTagName("displayname")[0];void 0!==g&&null!==g&&void 0!==g.childNodes[0]&&(c.displayName=g.childNodes[0].nodeValue)}}else{var h=b.getElementsByTagName("error")[0];h&&(c.error=h.childNodes[0].nodeValue)}return c}}},meeting_point_controlled:{include:"xml_utils",parse:function(a){var b=a.getElementsByTagName("meetingpointcontrolled")[0];if(b){options={},options.status=b.getAttribute("status");var c=this;return arrayForEach(["action","uid","mode","error"],function(a){c.getChildrenIfExists(options,b,a)}),options.id=b.getElementsByTagName("meetingpointid")[0].childNodes[0].nodeValue,options}}},meeting_point_created:{include:"xml_utils",parse:function(a){var b=a.getElementsByTagName("meetingpointcreated")[0];if(b){var c={},d=b.getAttribute("status");return c.status=d,"ok"===d?(c.id=b.getElementsByTagName("meetingpointid")[0].childNodes[0].nodeValue,c.hostUrl=this.getKeyIfExists(b,"hosturl"),c.attendeeUrl=this.getKeyIfExists(b,"attendeeurl")):(error=b.getElementsByTagName("error")[0],error&&(c.error=error.childNodes[0].nodeValue)),c}}},meeting_point_deleted:{parse:function(a){var b=a.getElementsByTagName("meetingpointdeleted")[0];if(b){var c={},d=b.getAttribute("status");if(c.status=d,c.id=currentMeetingPointDeletedId,"ok"!==d){var e=b.getElementsByTagName("error")[0];e&&(c.error=e.childNodes[0].nodeValue)}return c}}},meeting_point_got:{include:"xml_utils",parse:function(a){var b=a.getElementsByTagName("meetingpointgot")[0];if(b){var c={},d=b.getAttribute("status");return c.status=d,"ok"===d?(c.id=b.getElementsByTagName("meetingpointid")[0].childNodes[0].nodeValue,c.hostUrl=this.getKeyIfExists(b,"hosturl"),c.attendeeUrl=this.getKeyIfExists(b,"attendeeurl"),c.type=b.getElementsByTagName("type")[0].childNodes[0].nodeValue,c.startDate=this.getKeyIfExists(b,"startdate"),c.mode=this.getKeyIfExists(b,"mode"),c.stopDate=this.getKeyIfExists(b,"stopdate"),c.location=this.getKeyIfExists(b,"location"),c.title=this.getKeyIfExists(b,"title")):(error=b.getElementsByTagName("error")[0],error&&(c.error=error.childNodes[0].nodeValue)),c}}},meeting_point_hosted:{parse:function(a){var b=a.getElementsByTagName("meetingpointhosted")[0];if(void 0!==b&&null!==b){var mode,c={};c.id=b.getElementsByTagName("meetingpointid")[0].childNodes[0].nodeValue;var d=b.getAttribute("status");if(c.status=d,mode=b.getAttribute("mode"),"1"===mode?c.callType=Rtcc.callType.ONE_TO_ONE:c.callType=Rtcc.callType.N_TO_N,"ok"!==d){var e=b.getElementsByTagName("error")[0];e&&(c.error=e.childNodes[0].nodeValue)}return c}}},meeting_point_modified:{parse:function(a){var b=a.getElementsByTagName("meetingpointmodified")[0];if(b){var c={},d=b.getAttribute("status");if(c.status=d,c.id=b.getElementsByTagName("meetingpointid")[0].childNodes[0].nodeValue,"ok"!==d){var e=b.getElementsByTagName("error")[0];e&&(c.error=e.childNodes[0].nodeValue)}return c}}},meeting_point_requested:{parse:function(a){var b=a.getElementsByTagName("meetingpointrequested")[0];if(b){var c={};c.id=b.getElementsByTagName("meetingpointid")[0].childNodes[0].nodeValue,c.status=b.getAttribute("status");var d=b.getElementsByTagName("timestamp")[0];if(d&&(c.timestamp=d.childNodes[0].nodeValue),"ok"!==c.status){var e=b.getElementsByTagName("error")[0];e&&(c.error=e.childNodes[0].nodeValue)}else c.status=b.getElementsByTagName("request")[0].childNodes[0].nodeValue,b.getElementsByTagName("uid")[0]&&b.getElementsByTagName("uid")[0].childNodes[0]&&(c.uid=b.getElementsByTagName("uid")[0].childNodes[0].nodeValue),b.getElementsByTagName("displayname")[0]&&b.getElementsByTagName("displayname")[0].childNodes[0]&&(c.displayName=b.getElementsByTagName("displayname")[0].childNodes[0].nodeValue);return c}}},message_received:{parse:function(a){var b=a.getElementsByTagName("presencemessage")[0];if(b){var c={};return c.uid=b.getAttribute("from"),c.message_id=b.getAttribute("id"),b.childNodes[0]?c.message=b.childNodes[0].nodeValue:c.message="",c}}},peripherals:{convert:function(a){a=this.convertToArray(a);for(var b=0;b<a.length;b++)a[b]=this.convertItem(a[b]);return a},convertItem:function(a){return{id:Number(a["@id"]),selected:"1"===a["@selected"],name:a["#text"]}},convertToArray:function(a){return a instanceof Array==!1?[a]:a},parse:function(a){var b=a.getElementsByTagName("peripherals")[0];if(b){var c=JXON.xmlDoc2jsonObject(a),d={audio_capture:this.convert(c.peripherals.audiocap.p),audio_playback:this.convert(c.peripherals.audioplay.p),video_capture:this.convert(c.peripherals.videocap.p)};return d}}},permanent_meeting_point_got:{parse:function(a){var b=a.getElementsByTagName("permanentmeetingpointgot")[0];if(b){var c={},d=b.getAttribute("status");return c.status=d,"ok"===d?b.getElementsByTagName("attendeeurl")[0].childNodes[0]&&(c.attendeeUrl=b.getElementsByTagName("attendeeurl")[0].childNodes[0].nodeValue):(error=b.getElementsByTagName("error")[0],error&&(c.error=error.childNodes[0].nodeValue)),c}}},preprocessor:{execute:function(a){var b;return window.DOMParser?(parser=new DOMParser,b=parser.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a)),b}},presence_burstupdate:{include:["plugin_convert_presence_payload"],parse:function(a){var b=a.getElementsByTagName("presenceburstupdate")[0];return b?this.convertPresencePayload(b):void 0}},presence_received:{parse:function(a){var b=a.getElementsByTagName("userregistered")[0];if(b){var c={};return c.rosterlen=Number(b.getAttribute("len")),c.status=b.childNodes[0].nodeValue,"unregistered"===c.status?"presenceNok":c}}},presence_update:{include:["plugin_convert_presence_payload"],parse:function(a){var b=a.getElementsByTagName("presenceupdate")[0];return b?this.convertPresencePayload(b):void 0}},presence_wholeroster:{include:"plugin_convert_chunked_presence_payload",parse:function(a){var b=a.getElementsByTagName("roster")[0];if(b){var c={};return c.length=Number(b.getAttribute("len")),c.uid_array=this.convertPresencePayload(b),c}}},readyforauthentication_received:{parse:function(a){var b=a.getElementsByTagName("readyforauthentication")[0];return b?!0:void 0}},roster_updated:{parse:function(a){var b=a.getElementsByTagName("rosterupdated")[0];if(b){var c={};return c.length=Number(b.getAttribute("len")),c.updated=Number(b.getAttribute("updated")),c}}},set_received:{parse:function(a){var b=a.getElementsByTagName("set")[0];if(b){var c={},d=b.getAttribute("displayname"),e=b.getAttribute("myref"),f=b.getAttribute("version"),g=b.getAttribute("status"),h=b.getAttribute("callwindowdefaultposition"),i=b.getAttribute("pluginmode");return i?(global_config.pluginMode=i,void apiEvents.trigger("plugin.mode."+i)):(null!==e?(c.name="myref",c.value=e):null!==d?(c.name="displayName",c.value=d.decodeHTML()):null!==f?(c.name="version",c.value=f):null!==g?(c.name="status",c.value=parseInt(g,10),c.uid=b.getAttribute("uid")):null!==h&&(c.name="callWindowDefaultPosition",c.value=h),c)}}},sip_message_received:{parse:function(a){var b=a.getElementsByTagName("message")[0];if(b){options={};var c=b.getAttribute("fromid");options.id=Number(c);var d=b.getAttribute("from");return options.displayName=d,options.message=b.childNodes[0].nodeValue,options}}},sip_recieved:{parse:function(a){var b=a.getElementsByTagName("status")[0];if(b){var c=b.getElementsByTagName("sip")[0];if(c)return"ok"===c.childNodes[0].nodeValue?{type:"plugin",status:"ok"}:{status:"nok"}}}},six_digits_deleted:{parse:function(a){var b=a.getElementsByTagName("sixdigitsdeleted")[0];if(b){if(options={},statusNode=b.getAttribute("status"),options.status=statusNode,"ko"===options.status){var c=b.getElementsByTagName("error")[0];c&&(options.error=c.childNodes[0].nodeValue)}return options}}},sixdigits_created:{include:"xml_utils",parse:function(a){var b=a.getElementsByTagName("sixdigitscreated")[0];if(b){var c={};if(c.status=b.getAttribute("status"),"ok"===c.status)c.sixdigits=this.getKeyIfExists(b,"sixdigits");else{var d=b.getElementsByTagName("error")[0];d&&(c.error=d.childNodes[0].nodeValue)}return c}}},stats:{parse:function(a){var b=a.getElementsByTagName("callstats")[0];if(b){var c=JXON.xmlDoc2jsonObject(a),d={outputBandwidth:Number(c.callstats.obw),inputBandwidth:Number(c.callstats.ibw),outputResolution:{width:Number(c.callstats.ow),height:Number(c.callstats.oh)},inputResolution:{width:Number(c.callstats.iw),height:Number(c.callstats.ih)},grabRate:Number(c.callstats.gr),sendRate:Number(c.callstats.sr),receiveRate:Number(c.callstats.rr),videoPacketsLost:Number(c.callstats.vpl),missingAudioPackets:Number(c.callstats.map),cpuLoad:Number(c.callstats.cpu)};return c.callstats.rt&&(d.realTimePlatform={name:c.callstats.rt,latency:Number(c.callstats.rtl)}),d}}},updating:{parse:function(a){var b=a.getElementsByTagName("updating")[0];return b?!0:void 0}},verifieduser_received:{parse:function(a){var b,c=a.getElementsByTagName("verifieduser")[0];if(c){var d={},e=c.getAttribute("sixdigits");if(e&&(d.sixdigits=e),b=c.childNodes[0].nodeValue,"ok"!==b&&"loggedasotheruser"!==b){var f=c.getElementsByTagName("error")[0];if(void 0!==f){var g=f.getAttribute("code");g&&(d.error=Number(g));var h=f.getAttribute("details");h&&(d.error_message=h)}}return[b,d,"plugin"]}}},wait_list_retreived:{convertPresencePayload:function(a){if(0===a.childNodes.length)return[];var b=a.childNodes[0];return a.removeChild(b),
[{uid:b.childNodes[0].nodeValue,value:b.getAttribute("value"),mask:b.getAttribute("mask")}].concat(this.convertPresencePayload(a))},parse:function(a){var b=a.getElementsByTagName("acdwaitinglist")[0];if(b){var c={};return c.length=Number(b.getAttribute("len")),c.uid_array=this.convertPresencePayload(b),c}}},wall_got:{include:"xml_utils",parse:function(a){var b=a.getElementsByTagName("wallgot")[0];if(b){var c={};if(statusNode=b.getAttribute("status"),c.status=statusNode,"ok"===statusNode)c.first_name=this.getKeyIfExists(b,"first_name"),c.last_name=this.getKeyIfExists(b,"last_name"),c.company_name=this.getKeyIfExists(b,"company_name"),c.email=this.getKeyIfExists(b,"email"),c.language=this.getKeyIfExists(b,"language"),c.gender=this.getKeyIfExists(b,"gender"),c.nickname=this.getKeyIfExists(b,"nickname"),c.company_website=this.getKeyIfExists(b,"company_website"),c.street_address=this.getKeyIfExists(b,"street_address"),c.postal_code=this.getKeyIfExists(b,"postal_code"),c.state=this.getKeyIfExists(b,"state"),c.country=this.getKeyIfExists(b,"country"),c.mobile=this.getKeyIfExists(b,"mobile"),c.linkedin=this.getKeyIfExists(b,"linkedin"),c.google_plus=this.getKeyIfExists(b,"google_plus"),c.twitter=this.getKeyIfExists(b,"twitter"),c.facebook=this.getKeyIfExists(b,"facebook");else{var d=b.getAttribute("error");d&&(c.error=d)}return c}}},wall_updated:{parse:function(a){var b=a.getElementsByTagName("wallupdated")[0];if(b){var c={};if(statusNode=b.getAttribute("status"),c.status=statusNode,"ok"!==statusNode){var d=b.getAttribute("error");d&&(c.error=d)}return c}}}},webrtc_parsers={acknowledge_received:{parse:function(a){if("dc_ackrcvd"===a.cmd){var b={};return b.message_id=a.args[0],b.uid=a.args[1],b.status=a.args[2],b}}},agent_or_queue_received:{convertChunkedPresenceArray:function(a){var b=a.splice(0,2);return b.length>0?[{uid:b[1],presence:b[0]}].concat(this.convertChunkedPresenceArray(a)):[]},parse:function(a){if("acd_list"===a.cmd){var b=a.args,c={queue:{position:Number(b[0]),length:Number(b[1])},agents:{length:Number(b[2]),uid_array:this.convertChunkedPresenceArray(b.slice(3))}};return c}}},call_audio_received:{parse:function(a){if("call_audio_received"===a.cmd){a.args}}},call_created:{parse:function(a){if("createdcall"===a.cmd){var b=a.args;return b}}},call_status_received:{parse:function(a){if("statuscall"===a.cmd){var b=a.args,c={};return c.id=b[0],c.type=b[1],c.reason=b[2],c}}},call_update_video_profile:{parse:function(a){if("updatevideoprofile"===a.cmd){var b=a.args,c=b[0],d=global_config.callObjects,e=d[c];e?e.trigger("video.profile.request",b[1]):debug("call "+c+"has already been destroyed")}}},call_video_received:{parse:function(a){if("call_video_received"===a.cmd){a.args}}},client_call_requested:{parse:function(a){if("acd_request"===a.cmd){var b=a.args,c={type:b[0],uid:b[1]};return c}}},conference_status:{parse:function(a){if("conferencestatus"===a.cmd){var b=a.args,c={myId:b[2],isHost:b[3]};return c}}},error_received:{parse:function(a){"error"===a.cmd&&(debug("ERROR"),debug(a.args))}},get_result:{parse:function(a){if("get_result"===a.cmd){var b=a.args;return b}}},hold:{parse:function(a){if("hold"===a.cmd){a.args}}},meeting_point_attended:{parse:function(a){if("meetingpointattended"===a.cmd){var b=a.args,c={};return c.status=b[0],c.id=b[1],"ok"===b[0]?(c.request=b[2],"invited"===b[2]&&(c.displayName=b[4]),b[5]&&(c.confHash=b[5])):c.error=b[2],c}}},meeting_point_controlled:{parse:function(a){if("meetingpointcontrolled"===a.cmd){var b={},c=a.args;return b.status=c[0],b.id=c[1],b.action=c[2],b.uid=c[3],"ok"!==b.status&&(b.error=c[5]),b}}},meeting_point_created:{parse:function(a){if("meetingpointcreated"===a.cmd){var b={};return b.status=a.args[0],"ok"===b.status?(b.id=a.args[1],b.hostUrl=a.args[2],b.attendeeUrl=a.args[3]):b.error=a.args[1],b}}},meeting_point_deleted:{parse:function(a){if("meetingpointdeleted"===a.cmd){var b=a.args,c={};return c.status=b[0],c.id=currentMeetingPointDeletedId,"ok"!==c.status&&(c.error=b[2]),c}}},meeting_point_got:{parse:function(a){if("meetingpointgot"===a.cmd){var b={},c=a.args;return b.id=c[1],b.status=c[0],"ok"===c[0]?(b.hostUrl=c[7],b.attendeeUrl=c[8],b.mode=c[9],b.type=c[2],b.startDate=c[3],b.stopDate=c[4],b.location=c[6],b.title=c[5]):b.error=c[2],b}}},meeting_point_hosted:{parse:function(a){if("meetingpointhosted"===a.cmd){var b={},c=a.args;return b.status=c[0],b.id=c[1],b.callType=c[2],"ok"!==c[0]&&(b.error=c[2]),b}}},meeting_point_modified:{parse:function(a){if("meetingpointmodified"===a.cmd){var b={},c=a.args;return b.status=c[0],b.id=c[1],"ok"===c[0]?(b.hostUrl=c[2],b.attendeeUrl=c[3]):b.error=c[2],b}}},meeting_point_requested:{parse:function(a){if("meetingpointrequested"===a.cmd){var b={},c=a.args;return b.id=c[1],"ok"===c[0]?(b.status=c[2],b.uid=c[3],b.displayName=c[4]):(b.status=c[0],b.error=c[2]),b}}},message_received:{parse:function(a){if("dc_send"===a.cmd){var b={};return b.message_id=a.args[0],b.uid=a.args[1],b.message=a.args[2],b}}},permanent_meeting_point_got:{parse:function(a){if("permanentmeetingpointgot"===a.cmd){var b={},c=a.args;return b.status=c[0],"ok"===c[0]?b.attendeeUrl=c[1]:b.error=c[1],b}}},pong:{parse:function(a){return"pong"===a.cmd?(vent.trigger("pong"),!0):void 0}},preprocessor:{execute:function(a){try{return JSON.parse(a)}catch(b){debug("error parsing json: "+a),debug(b.stack)}}},presence_burstupdate:{include:["webrtc_convert_presence_payload"],parse:function(a){return"presence_burstupdate"===a.cmd?this.convertPresencePayload(a.args):void 0}},presence_received:{parse:function(a){return"user_registered"===a.cmd?{status:a.args[0],rosterlen:a.args[1]}:"user_unregistered"===a.cmd?"presenceNok":void 0}},presence_update:{include:["webrtc_convert_presence_payload"],parse:function(a){return"presence_update"===a.cmd?this.convertPresencePayload(a.args):void 0}},presence_wholeroster:{include:"webrtc_convert_chuncked_presence_payload",parse:function(a){if("presence_wholeroster"===a.cmd){var b={};return b.length=Number(a.args[0]),b.uid_array=this.convertChunkedPresenceArray(a.args.slice(1)),b}}},roster_updated:{parse:function(a){return"roster_updated"===a.cmd?{length:Number(a.args[0]),updated:Number(a.args[1])}:void 0}},sip_message_received:{parse:function(a){if("message"===a.cmd){var b=(a.args,{});return b.id=Number(a.args[1]),b.displayName=a.args[0],b.message=a.args[2],b}}},sip_recieved:{parse:function(a){return"status"===a.cmd&&"sip"===a.args[0]?{type:"webrtc",status:a.args[1]}:void 0}},six_digits_deleted:{parse:function(a){if("sixdigitsdeleted"===a.cmd){a.args;return a.args}}},sixdigits_created:{parse:function(a){if("sixdigitscreated"===a.cmd){var b=a.args;return b.digits&&(b.sixdigits=b.digits,delete b.digits),b}}},updatemedia:{parse:function(a){if("updatemedia"===a.cmd){var b=a.args,c=b[0],d=global_config.callObjects,e=d[c];e?e._updateMedia(b):debug("call "+c+"has already been destroyed")}}},verifieduser_received:{parse:function(a){if("verifieduser"===a.cmd){var b,c={};return b=a.args[0],"ok"!==b?(c.error=Number(a.args[1]),c.error_message=a.args[2]):a.args[1]&&(c.sixdigits=a.args[1]),[b,c,"webrtc"]}}},wait_list_retreived:{convertChunkedPresenceArray:function(a){var b=a.splice(0,3);return b.length>0?[{uid:b[2],value:b[0],mask:b[1]}].concat(this.convertChunkedPresenceArray(a)):[]},parse:function(a){if("acd_waitingqueue"===a.cmd){var b={};return b.length=Number(a.args[0]),b.uid_array=this.convertChunkedPresenceArray(a.args.slice(1)),b}}},wall_got:{parse:function(a){return"wallgot"===a.cmd?a.args[0]:void 0}},wall_updated:{parse:function(a){return"wallupdated"===a.cmd?a.args[0]:void 0}}},response_handlers={acknowledge_received:{handle:function(a){run_client_callback(weemo,"onAcknowledgeReceived",[a.message_id,a.uid,a.status]),apiEvents.trigger("message.acknowledge",a.message_id,a.uid,a.status)}},agent_or_queue_received:{current_agent_queue_being_loaded:[],handle:function(a){a.queue.position>0?(run_client_callback(weemo,"onCallDistributorQueueUpdate",[a.queue]),apiEvents.trigger("calldistributor.queue.update",a.queue)):(this.current_agent_queue_being_loaded=this.current_agent_queue_being_loaded.concat(a.agents.uid_array),this.current_agent_queue_being_loaded.length===a.agents.length&&(apiEvents.trigger("calldistributor.agent.available",this.current_agent_queue_being_loaded),run_client_callback(weemo,"onCallDistributorAgentAvailable",[this.current_agent_queue_being_loaded]),this.current_agent_queue_being_loaded=[]))}},audio_receieved:{handle:function(a){"ok"===a?(run_client_callback(weemo,"onConnectionHandler",["audioOk",0]),apiEvents.trigger("audio.ok")):(run_client_callback(weemo,"onConnectionHandler",["audioNok",0]),apiEvents.trigger("audio.ko"))}},blob_received:{video:"",share:"",handle:function(a){this[a.type]+=a.value,a.current===a.total&&(apiEvents.trigger("image.save",this[a.type]),apiEvents.trigger("image.save."+a.type,this[a.type]),this[a.type]="")}},call_audio_received:{handle:function(a){run_client_callback(weemo,"onTest",["audioreceived"]),apiEvents.trigger("test.audioreceived")}},call_created:{handle:function(a){weemo.requests.run("call_created",[a])}},call_status_received:{current_share_list:[],handle:function(a){var b=global_config.callObjects[a.id];if(!b)return void debug("call "+a.id+"has already been destroyed");if(a.conference&&global_config.plugin&&(a.conference.floor?globalVars.webRtcUi.setPassiveVideoBoxes(a.conference.floor):a.conference.participantList&&globalVars.webRtcUi.setParticipantList(a.conference.participantList)),"share_local_list"===a.type){if(this.current_share_list.push({id:a.item_id,name:a.item_name}),this.current_share_list.length!==a.item_number)return;var c=a;a={},a.id=c.id,a.type=c.type,a.status=this.current_share_list,this.current_share_list=[]}b._updateCallStatus(a),"terminated"===a.status&&(global_config.callObjects[a.id].terminated=!0,delete global_config.callObjects[a.id])}},call_video_received:{handle:function(a){run_client_callback(weemo,"onTest",["videoreceived"]),apiEvents.trigger("test.videoreceived")}},client_call_requested:{client_requests:{},handle:function(a){this.client_requests[a.uid]=new ClientCallRequest(a.uid),"canceled"===a.type&&(this.client_requests[a.uid].status="canceled"),run_client_callback(weemo,"onCallDistributorClientCallRequest",[this.client_requests[a.uid]]),apiEvents.trigger("calldistributor.request",this.client_requests[a.uid])}},conference_status:{handle:function(a){globalVars.webRtcUi.setWelcome&&globalVars.webRtcUi.setWelcome(a.myId,a.isHost)}},dropped_received:{handle:function(a){modeFacade.websock.close(),run_client_callback(weemo,"onConnectionHandler",["dropped",null]),apiEvents.trigger("cloud.drop")}},get_result:{handle:function(a){var b,c={};"displayname"===a[0]?(c.name="displayName",c.value=a[1],b=a[1],global_config.displayName=a[1]):"myref"===a[0]?(c.name="myref",c.value=a[1],b=a[1]):"status"===a[0]&&(c.name="status",c.uid=a[1],c.value=Number(a[2]),b={uid:a[1],value:c.value}),run_client_callback(weemo,"onGetHandler",[c.name,c]),apiEvents.trigger("get."+c.name.toLowerCase(),b),apiEvents.trigger("get",c.name,c)}},hold:{handle:function(a){run_client_callback(weemo,"onConnectionHandler",["loggedonotherdevice",0]),apiEvents.trigger("cloud.alreadyconnected")}},inband_received:{handle:function(a){run_client_callback(weemo,"onInbandMessageReceived",[a]),apiEvents.trigger("message.inband",a),globalVars.call?globalVars.call.trigger("inband.message.receive",a):debug("No call established")}},kicked_received:{handle:function(a){modeFacade.websock.close()}},meeting_point_attended:{handle:function(a){var b;if("ok"!==a.status)return apiEvents.trigger("meetingpoint.attendee.error",a.id,a.error),run_client_callback(weemo,"onConfCallHandler",["attendeeError",{status:"error",error:a.error,id:a.id}]);if("invited"===a.request)meetingPointAttendees[a.id]=new MeetingPointAttendee(a.id,a.displayName),meetingPointAttendees[a.id].status="waitingForApproval",run_client_callback(weemo,"onConfCallHandler",["attendeeInvited",meetingPointAttendees[a.id]]),apiEvents.trigger("meetingpoint.attendee.invite",meetingPointAttendees[a.id]);else{var c=meetingPointAttendees[a.id];if(c){if(c.status="ok","pending"===a.request)c.status="waitingForApproval",b="attendeePending",apiEvents.trigger("meetingpoint.attendee.pending",c);else if("accepted"===a.request)a.confHash&&(c.confHash=a.confHash),c.status="accepted",global_config.standAlone!==!0&&(c.isNoVideo?weemo.createCallNoVideo(a.id,"attendee","conference"):weemo.createCall(a.id,"attendee","conference")),b="attendeeAccepted",apiEvents.trigger("meetingpoint.attendee.accept",c);else if("denied"===a.request)c.status=a.request,b="attendeeDenied",apiEvents.trigger("meetingpoint.attendee.deny",c);else{if("meetingcancelled"!==a.request)throw"Unexpected request parameter: "+a.request;b="meetingCancelled",apiEvents.trigger("meetingpoint.cancel")}return run_client_callback(weemo,"onConfCallHandler",[b,c])}debug("no meeting point created",{show_on_debug_level:3})}}},meeting_point_controlled:{handle:function(a){"invite"===a.action?("ok"===a.status&&(a.status="waitingForApproval"),run_client_callback(weemo,"onConfCallHandler",["joinRequestSent",a]),"ko"===a.status?(apiEvents.trigger("error",a.error),apiEvents.trigger("meetingpoint.joinrequest.error",a.id,a,a.error)):apiEvents.trigger("meetingpoint.joinrequest.send",a.id,a)):"accept"===a.action?createdMeetingPoints[a.id]&&createdMeetingPoints[a.id].attendees[a.uid]&&(createdMeetingPoints[a.id].attendees[a.uid].status="accepted"):"deny"===a.action?createdMeetingPoints[a.id]&&createdMeetingPoints[a.id].attendees[a.uid]?createdMeetingPoints[a.id].attendees[a.uid].status="denied":joinRequestNotifications[a.id]&&joinRequestNotifications[a.id][a.uid]&&(joinRequestNotifications[a.id][a.uid].status="denied"):("locked"===a.action||"default"===a.action||"auto-accept"===a.action)&&("ok"===a.status?apiEvents.trigger("meetingpoint.joinmode.update.success",a.action,createdMeetingPoints[a.id]):apiEvents.trigger("meetingpoint.joinmode.update.error",a.action,createdMeetingPoints[a.id]))}},meeting_point_created:{handle:function(a){if("ok"===a.status)global_config.meetingPointBeingCreated.id=a.id,global_config.meetingPointBeingCreated.status="saved",global_config.meetingPointBeingCreated.hostUrl=a.hostUrl,global_config.meetingPointBeingCreated.attendeeUrl=a.attendeeUrl,createdMeetingPoints[a.id]=global_config.meetingPointBeingCreated,run_client_callback(weemo,"onConfCallHandler",["meetingPointCreated",createdMeetingPoints[a.id]]),apiEvents.trigger("meetingpoint.create.success",createdMeetingPoints[a.id]);else{global_config.meetingPointBeingCreated.status="errorSaving",global_config.meetingPointBeingCreated.error=a.error;var b=global_config.meetingPointBeingCreated;run_client_callback(weemo,"onConfCallHandler",["meetingPointCreated",b]),apiEvents.trigger("error",a.error),apiEvents.trigger("meetingpoint.create.error",b)}}},meeting_point_deleted:{handle:function(a){var b={};"ok"===a.status?(b.status="deleted",apiEvents.trigger("meetingpoint.delete.success",a.id)):(b.status="errorDeleting",b.error=a.error,apiEvents.trigger("error",a.error),apiEvents.trigger("meetingpoint.delete.error",a.id,a.error)),run_client_callback(weemo,"onConfCallHandler",["meetingPointDeleted",b])}},meeting_point_got:{handle:function(a){"ok"===a.status?(a.status="saved",createdMeetingPoints[a.id]=new MeetingPointHost(a.type,a),run_client_callback(weemo,"onConfCallHandler",["meetingPointGot",createdMeetingPoints[a.id]]),apiEvents.trigger("meetingpoint.get.success",createdMeetingPoints[a.id])):(run_client_callback(weemo,"onConfCallHandler",["meetingPointGot",a]),apiEvents.trigger("error",a.error),apiEvents.trigger("meetingpoint.get.error",a.error))}},meeting_point_hosted:{handle:function(a){a.callType&&(createdMeetingPoints[a.id].callType=a.callType),"ok"===a.status?(createdMeetingPoints[a.id].status="started",a.callType!==Rtcc.callType.ONE_TO_ONE&&(createdMeetingPoints[a.id].isNoVideo?weemo.createCallNoVideo(a.id,"host","conference"):weemo.createCall(a.id,"host","conference")),apiEvents.trigger("meetinpoint.host.success",createdMeetingPoints[a.id]),apiEvents.trigger("meetingpoint.host.success",createdMeetingPoints[a.id])):(createdMeetingPoints[a.id].status="startFailed",createdMeetingPoints[a.id].error=a.error,apiEvents.trigger("error",a.error),apiEvents.trigger("meetingpoint.host.error",a.id,a.error)),run_client_callback(weemo,"onConfCallHandler",["meetingPointHosted",createdMeetingPoints[a.id]])}},meeting_point_modified:{handle:function(a){"ok"===a.status?(createdMeetingPoints[a.id].modify_success_callback(),apiEvents.trigger("meetingpoint.modify.success",createdMeetingPoints[a.id])):(createdMeetingPoints[a.id].status="errorModifing",createdMeetingPoints[a.id].error=a.error,createdMeetingPoints[a.id].modify_failure_callback(),apiEvents.trigger("error",a.error),apiEvents.trigger("meetingpoint.modify.error",a.id,a.error)),run_client_callback(weemo,"onConfCallHandler",["meetingPointModified",createdMeetingPoints[a.id]])}},meeting_point_requested:{handle:function(a){var b=createdMeetingPoints[a.id];if("requesttoattend"===a.status)if(b)attendee=new Attendee(a.id,a.uid,a.displayName),a.timestamp?attendee.timestamp=a.timestamp:attendee.timestamp=Math.round((new Date).valueOf()/1e3),b.attendees[a.uid]=attendee,run_client_callback(weemo,"onConfCallHandler",["joinRequest",attendee]),apiEvents.trigger("meetingpoint.joinrequest.new",attendee);else{var c="The meeting point "+a.id+" does not exists in current context!";debug(c),apiEvents.trigger("error",c),apiEvents.trigger("meetingpoint.joinrequest.error",a.id,c)}else if("accepted"===a.status)b.attendees[a.uid].status="ok",b.attendees[a.uid].displayName=a.displayName,b.attendees[a.uid].timestamp=a.timestamp,run_client_callback(weemo,"onConfCallHandler",["joinRequestAccepted",b.attendees[a.uid]]),apiEvents.trigger("meetingpoint.joinrequest.accept",b.attendees[a.uid]);else if("denied"===a.status)b.attendees[a.uid].status="nok",b.attendees[a.uid].displayName=a.displayName,b.attendees[a.uid].timestamp=a.timestamp,run_client_callback(weemo,"onConfCallHandler",["joinRequestDenied",b.attendees[a.uid]]),apiEvents.trigger("meetingpoint.joinrequest.deny",b.attendees[a.uid]);else if("notification"===a.status){var d=a.timestamp;d||(d=Math.round((new Date).valueOf()/1e3));var e=new JoinRequestNotification({id:a.id,uid:a.uid,timestamp:d,displayName:a.displayName});joinRequestNotifications[a.id]||(joinRequestNotifications[a.id]={}),joinRequestNotifications[a.id][a.uid]=e,run_client_callback(weemo,"onConfCallHandler",["joinRequestNotification",e]),apiEvents.trigger("meetingpoint.notification",e)}else if("requestcancelled"===a.status){var f={id:a.id,uid:a.uid,displayName:a.displayName};delete b.attendees[a.uid],run_client_callback(weemo,"onConfCallHandler",["joinRequestCancelled",f]),apiEvents.trigger("meetingpoint.joinrequest.cancel",f)}}},message_received:{handle:function(a){run_client_callback(weemo,"onMessageReceived",[a.message_id,a.uid,a.message]),apiEvents.trigger("message.receive",a.message_id,a.uid,a.message)}},peripherals:{handle:function(a){apiEvents.trigger("media.devices",a)}},permanent_meeting_point_got:{handle:function(a){run_client_callback(weemo,"onConfCallHandler",["permanentMeetingPointGot",a])}},presence_burstupdate:{handle:function(a){run_client_callback(weemo,"onBurstUpdate",[a]),apiEvents.trigger("presence.burstupdate",a)}},presence_received:{handle:function(a){"presenceNok"===a?(run_client_callback(weemo,"onConnectionHandler",["presenceNok"]),apiEvents.trigger("presence.ko"),globalVars.presence_state=Rtcc.PRESENCE_STATES.NOK):(globalVars.presence_state=Rtcc.PRESENCE_STATES.OK,32===Number(a.status)||"alreadyregistered"===a.status?(run_client_callback(weemo,"onConnectionHandler",["presenceOkAlreadyRegistered",a.rosterlen]),apiEvents.trigger("presence.alreadyregistered"),apiEvents.trigger("presence.ok",a.rosterlen)):(16===Number(a.status)||"newuser"===a.status)&&(run_client_callback(weemo,"onConnectionHandler",["presenceOkNewUser",a.rosterlen]),apiEvents.trigger("presence.newuser"),apiEvents.trigger("presence.ok",a.rosterlen)))}},presence_update:{handle:function(a){run_client_callback(weemo,"onPresenceUpdate",[a]),apiEvents.trigger("presence.update",a)}},presence_wholeroster:{current_roster_being_loaded:[],handle:function(a){this.current_roster_being_loaded=this.current_roster_being_loaded.concat(a.uid_array),this.current_roster_being_loaded.length===a.length&&(run_client_callback(weemo,"onRosterRetrieved",[this.current_roster_being_loaded]),apiEvents.trigger("presence.roster.retrieve",this.current_roster_being_loaded),this.current_roster_being_loaded=[])}},readyforauthentication_received:{handle:function(a){clearTimeout(globalVars.timeout.pluginConnect),actions.authenticate(global_config)}},roster_updated:{handle:function(a){run_client_callback(weemo,"onRosterUpdated",["ok",a]),apiEvents.trigger("presence.roster.update",a.updated,a.length)}},set_received:{handle:function(a){"displayName"===a.name&&(global_config.displayName=a.value),run_client_callback(weemo,"onGetHandler",[a.name,a]),apiEvents.trigger("get",a);var b;b=a.uid?{uid:a.uid,value:a.value}:a.domain?{domain:a.domain,value:a.value}:a.value,apiEvents.trigger("get."+a.name.toLowerCase(),b)}},sip_message_received:{handle:function(a){var b=a.message.substr(1);arrayContains(global_config.non_uid_ids_for_sending_messages,a.id)||global_config.non_uid_ids_for_sending_messages.push(a.id);var c=base64DecToArr(b),d=UTF8ArrToStr(c);run_client_callback(weemo,"onDataChannelMessageReceived",[a.id,a.displayName,d]),apiEvents.trigger("message.datachannel",a.id,a.displayName,d)}},sip_recieved:{handle:function(a){var b=global_config.callObjects;"ok"===a.status?(globalVars.state=Rtcc.STATES.SIP_OK,vent.trigger("sip_ok_"+a.type),global_config.sixDigitNoCall||("1"===globalVars.sixDigitsCallMode?weemo.createCall("ignoreduid","sixdigits","Call Starting"):"n"===globalVars.sixDigitsCallMode&&weemo.joinConfCall("sixdigits_meetingpointid")),run_client_callback(weemo,"onConnectionHandler",["sipOk",0]),apiEvents.trigger("cloud.sip.ok"),"webrtc"===a.type&&(weemo.isShareExtensionLoaded()?apiEvents.trigger("chrome.screenshare.loaded"):apiEvents.trigger("chrome.screenshare.missing",globalVars.screenShareExtentionUrl))):(globalVars.state=Rtcc.STATES.SIP_NOK,objectForEach(b,function(a,b){b.hangup()}),global_config.callObjects={},run_client_callback(weemo,"onConnectionHandler",["sipNok",0]),apiEvents.trigger("cloud.sip.ko"))}},six_digits_deleted:{handle:function(a){run_client_callback(weemo,"onSixDigitsDeleted",[a]),"ok"===a.status?apiEvents.trigger("sixdigits.delete.success"):a.error?apiEvents.trigger("sixdigits.delete.error",a.error):apiEvents.trigger("sixdigits.delete.error")}},sixdigits_created:{handle:function(a){run_client_callback(weemo,"onSixDigitsCreated",[a]),"ok"===a.status?apiEvents.trigger("sixdigits.create.success",a.sixdigits):a.error?apiEvents.trigger("sixdigits.create.error",a.error):apiEvents.trigger("sixdigits.create.error")}},stats:{handle:function(a){apiEvents.trigger("call.stats",a)}},updating:{handle:function(a){apiEvents.trigger("driver.update"),apiEvents.trigger("plugin.update")}},verifieduser_received:{handle:function(a){var b=a[1];if("loggedasotheruser"===a[0])run_client_callback(weemo,"onConnectionHandler",["loggedasotheruser",0]),apiEvents.trigger("cloud.loggedasotheruser");else if("ok"===a[0]){if(globalVars.state=Rtcc.STATES.VERIFIED_USER_OK,global_config.displayName&&weemo.setDisplayName(global_config.displayName),b.sixdigits&&(globalVars.sixDigitsCallMode=b.sixdigits),vent.trigger("verifieduser_ok_"+a[2]),run_client_callback(weemo,"onConnectionHandler",["authenticated",0]),apiEvents.trigger("cloud.authenticate.success"),"webrtc"===a[2]){var c={cmd:"configdetails",args:[global_config.os+" "+global_config.osVersion,"","","",global_config.version,global_config.browser+" "+global_config.browserVersion,document.location.href,String(modeFacade.latency),modeFacade.localAddress,global_config.hap]};modeFacade.send(c)}}else globalVars.state=Rtcc.STATES.VERIFIED_USER_NOK,"plugin"===a[2]&&run_client_callback(weemo,"onConnectionHandler",["unauthenticated",0]),b.error_message&&b.error?(apiEvents.trigger("error",b.error,b.error_message),apiEvents.trigger("cloud.authenticate.error",b.error,b.error_message),run_client_callback(weemo,"onConnectionHandler",["error",b.error,b.error_message])):b.error?(apiEvents.trigger("error",b.error),apiEvents.trigger("cloud.authenticate.error",b.error),run_client_callback(weemo,"onConnectionHandler",["error",b.error])):(apiEvents.trigger("error"),apiEvents.trigger("cloud.authenticate.error"),run_client_callback(weemo,"onConnectionHandler",["error"]))}},wait_list_retreived:{current_waitlist_being_loaded:[],handle:function(a){this.current_waitlist_being_loaded=this.current_waitlist_being_loaded.concat(a.uid_array),this.current_waitlist_being_loaded.length===a.length&&(apiEvents.trigger("calldistributor.waitlist.retrieve",this.current_waitlist_being_loaded),run_client_callback(weemo,"onWaitListRetrieved",[this.current_waitlist_being_loaded]),this.current_waitlist_being_loaded=[])}},wall_got:{handle:function(a){if(run_client_callback(weemo,"onConfCallHandler",["wallsettings",a]),"ok"===a.status){var b=clone(a);delete b.status,apiEvents.trigger("wallsettings.get.success",b)}else apiEvents.trigger("wallsettings.get.error",a.error)}},wall_updated:{handle:function(a){run_client_callback(weemo,"onConfCallHandler",["wallsettingsupdated",a]),"ok"===a.status?apiEvents.trigger("wallsettings.update.success"):apiEvents.trigger("wallsettings.update.error",a.error)}}},shared={allowed_after_connected:{allowed:function(){return globalVars.state>=Rtcc.STATES.CONNECTED_TO_FACADE}},allowed_after_presence_ok:{allowed:function(){return globalVars.presence_state>=Rtcc.PRESENCE_STATES.OK}},allowed_after_sip_ok:{allowed:function(){return globalVars.state>=Rtcc.STATES.SIP_OK}},allowed_after_verified_user_ok:{allowed:function(){return globalVars.state>=Rtcc.STATES.VERIFIED_USER_OK}},chunckable:{getNextChunk:function(a,b){var c=a.slice(0);return c.length>0?{next:c.splice(0,b),remainder:c}:{next:!1,remainder:!1}}},json_utils:{buildJsonArgs:function(a,b){return b=b||{},b=Rtcc.merge(this,b),b.startDate?a.push(b.startDate):a.push(""),b.stopDate?a.push(b.stopDate):a.push(""),b.title?a.push(b.title):a.push(""),b.location?a.push(b.location):a.push(""),a}},my_presence_validate_input:{validateInput:function(a){var b=Number(a);if(isNaN(b))throw new Error("Presence value must be numeric");if(b>255)throw new Error("Presence value must be no greater than 255");if(0>b)throw new Error("Presence value cannot be negative")}},plugin_convert_chunked_presence_payload:{convertPresencePayload:function(a){if(0===a.childNodes.length)return[];var b=a.childNodes[0];return a.removeChild(b),[{uid:b.childNodes[0].nodeValue,presence:Number(b.getAttribute("presence"))}].concat(this.convertPresencePayload(a))}},plugin_convert_presence_payload:{convertPresencePayload:function(a){if(0===a.childNodes.length)return[];var b=a.childNodes[0];return a.removeChild(b),[{uid:b.childNodes[0].nodeValue,presence:Number(b.getAttribute("presence"))}].concat(this.convertPresencePayload(a))}},roster_xml_builder:{uidToXml:function(a){return"<uid>"+a+"</uid>"},toXml:function(a,b){for(var c="<"+a+">",d=0;d<b.length;d++)c+=this.uidToXml(b[d]);return c+="</"+a+">"}},webrtc_convert_chuncked_presence_payload:{convertChunkedPresenceArray:function(a){var b=a.splice(0,2);return b.length>0?[{uid:b[1],presence:Number(b[0])}].concat(this.convertChunkedPresenceArray(a)):[]}},webrtc_convert_presence_payload:{convertPresencePayload:function(a){if(a.length>0){var b=Number(a.shift());return[{uid:a.shift(),presence:b}].concat(this.convertPresencePayload(a))}return[]}},xml_utils:{getKeyIfExists:function(a,b){var c=a.getElementsByTagName(b)[0];return c&&c.childNodes[0]&&"string"==typeof c.childNodes[0].nodeValue?c.childNodes[0].nodeValue.decodeHTML():void 0},getChildrenIfExists:function(a,b,c){var d=b.getElementsByTagName(c);d.length>0&&void 0!==d[0].childNodes[0]&&(a[c]=d[0].childNodes[0].nodeValue)},buildXmlArgs:function(a){a=a||{},a=Rtcc.merge(this,a);var b="";return a.startDate&&(b+="<startdate>"+a.startDate+"</startdate>"),a.stopDate&&(b+="<stopdate>"+a.stopDate+"</stopdate>"),a.title&&(b+="<title>"+a.title.encodeHTML()+"</title>"),a.location&&(b+="<location>"+a.location.encodeHTML()+"</location>"),b}}};global_config=load_configs(arguments,{version:version,downloadUrl:downloadUrl,endpointUrl:endpointUrl,uiBaseUrl:"https://static.rtccloud.net/ui/1.4.15/",mode_parameter:mode}),global_config=Rtcc.merge(global_config,system_info()),global_config.instance=instance,debug("OS : "+global_config.os),debug("OS version : "+global_config.osVersion),debug("Is mobile : "+global_config.mobile),debug("Browser : "+global_config.browser),debug("Browser version : "+global_config.browserVersion),debug("JS version : "+global_config.version),debug("Screensize : "+global_config.screenSize),debug("Mode : "+modeMap[global_config.mode_parameter]),debug("---------------------------");var start_in_audio_only=!1;this.requests=new RequestManager,this.responseManager=new ResponseManager,this.responseManager.handlers=response_handlers,this.responseManagerPlugin=this.responseManager.handle.bind(rtcc.responseManager),this.coredump=function(){this.requests.run("coredump")},this.coredumptext=function(){modeFacade.send("<coredumptext/>")},this.getDownloadUrl=function(){return downloadUrl},this.getMyRef=function(){this.requests.run("get_myref")},this.getSuffix=function(){return getSuffix()},this.getRtccUserType=function(a){return global_config.rtccUserType},this.getPluginVersion=function(){this.requests.run("get_version")},this.getRtccDriverVersion=function(){debug("this function is depreciated, please use `getPluginVersion`"),this.getPluginVersion()},this.getCurrentCall=function(){globalVars.call},this.setCallWindowDefaultPosition=function(a){this.requests.run("set_call_window_default_position",[a])},this.getCallWindowDefaultPosition=function(){this.requests.run("get_call_window_default_position")},this.setToken=function(a){globalVars.token=a},this.setAppId=function(a){global_config.appId=a},this.setWebAppId=this.setAppId,this.setTestMode=function(a){this.requests.run("set_test_mode",[a])},this.setJsApiVersionToPlugin=function(){this.requests.run("set_js_api_version_to_plugin",[global_config.version])},this.setJsApiVersionToDriver=function(){debug("`setJsApiVersionToDriver` is depreciated, please use `setJsApiVersionToPlugin`"),this.setJsApiVersionToPlugin()},this.getStats=function(){this.requests.run("get_stats")},this.setUrlReferer=function(a){this.requests.run("set_url_referer",[a])},this.setWebAppId=this.setAppId,this.setDebugLevel=function(a){global_config.debugLevel=a},this.setWideHeight=function(a){this.requests.run("set_wide_height",[a])},this.setDisplayName=function(a){global_config.displayName=a,this.requests.run("send_display_name",[a])},this.setRtccUserType=function(a){global_config.rtccUserType=a},this.setHap=function(a){global_config.hap=a},this.getVersion=function(){return global_config.version},this.getDisplayName=function(){return global_config.displayName},this.getStatus=function(a){this.requests.run("get_status",[a])},this.getToken=function(){return globalVars.token},this.getWebAppId=function(){return global_config.appId},this.initialize=function(a){actions.initialize(a)},this.setPluginMode=function(mode){this.requests.run("set_plugin_mode",[mode])},this.getPluginMode=function(){return global_config.pluginMode},this.forceAuthenticate=function(){globalVars.force_connect=!0,actions.authenticate(global_config)},this.authenticate=function(){debug("WARNING: authenticate is depreciated, please use forceAuthenticate instead",{show_on_debug_level:0}),this.forceAuthenticate()},this.bypass=function(){this.requests.run("verify_user",["bypass"])},this.createCall=function(a,b,c,d){var e={};e.uidToCall=a,e.type=b,start_in_audio_only=d,e.displayNameToCall=c,this.requests.run("create_call",[e,d]);
};var start_in_audio_only=!1;this.createCallNoVideo=function(a,b,c){this.createCall(a,b,c,!0)},this.sendInbandMessage=function(a){debug("WARNING: sendInbandMessage is depreciated in favor of `call.sendInbandMessage`"),globalVars.call&&globalVars.call.sendInbandMessage(a)},this.createSixDigits=function(a,b,c){this.requests.run("create_six_digits",[a,b,c])},this.deleteSixDigits=function(){this.requests.run("delete_six_digits")},this.setIceMode=function(a){this.requests.run("set_ice_mode",[a])},this.setStartupProfile=function(a){this.requests.run("set_startup_profile",[a])},this.disableAutomaticProfileUpdate=function(){globalVars.webRtcUi.setConfig("automaticProfileUpdate",!1)},this.enableAutomaticProfileUpdate=function(){globalVars.webRtcUi.setConfig("automaticProfileUpdate",!0)},this.setPickupMode=function(a){this.requests.run("set_pickup_mode",[a])},this.setSendToTopInterval=function(a){this.requests.run("set_send_to_top_interval",[a])},this.setDeadParty=function(a){this.requests.run("set_dead_party",[a])},this.sendMessageToPlugin=function(a){modeFacade.send(a)},this.sendMessageToDriver=function(a){debug("WARNING: sendMessageToDriver is depreciated, please use sendMessageToPlugin instead"),this.sendMessageToPlugin(a)},this.isShareExtensionLoaded=function(){return null!==document.getElementById("rtcc-desktop-capture-installed")},this.stop_reconnection_attempts=function(){global_config.stop_reconnection_attempts=!0},this.isPlugin=function(){return modeFacade.getConnectionMode()===Rtcc.connectionModes.PLUGIN},this.isPluginEmbeded=function(){return this.isPlugin()&&global_config.pluginMode===Rtcc.pluginMode.EMBEDDED},this.setStartupSize=function(a){this.requests.run("set_startup_size",[a])};var createdMeetingPoints={};this.createMeetingPoint=function(a,b){return global_config.meetingPointBeingCreated=new MeetingPointHost(a,b),global_config.meetingPointBeingCreated.create()?global_config.meetingPointBeingCreated:!1},this.setDisabledButtons=function(a){this.requests.run("set_disabled_buttons",[a])},this.getMeetingPoint=function(a){this.requests.run("get_meeting_point",[a])};var meetingPointAttendees=[];this.setMyPresence=function(a){this.requests.run("set_my_presence",[a])},this.getPeripherals=function(){return this.requests.run("getperipherals")},this.setPeripherals=function(a){this.requests.run("set_peripherals",[a])},this.setMyAcdPriority=function(a){this.requests.run("set_my_acd_priority",[a])},this.setMyAcdStatus=function(a){this.requests.run("set_my_acd_presence",[a])},this.getRoster=function(){this.requests.run("get_roster",[])},this.rosterAdd=function(a){this.requests.run("roster_add",[a,global_config])},this.toast=function(a){this.requests.run("toast",[a])},this.clearToasts=function(){this.requests.run("clear_toasts")},this.getPresence=function(a){this.requests.run("get_presence",[a,global_config])},this.rosterRemove=function(a){this.requests.run("roster_remove",[a,global_config])},this.rosterClear=function(){this.requests.run("roster_clear",[])},this.joinConfCall=function(a){return meetingPointAttendees[a]=new MeetingPointAttendee(a,"Conference"),meetingPointAttendees[a].request(),meetingPointAttendees[a]},this.joinConfCallNoVideo=function(a){return meetingPointAttendees[a]=new MeetingPointAttendee(a,"Conference"),meetingPointAttendees[a].isNoVideo=!0,meetingPointAttendees[a].request(),meetingPointAttendees[a]},this.sendDataChannelMessage=function(a,b){this.requests.run("send_data_channel_message",[a,b])},this.sendMessage=function(a,b,c){this.requests.run("send_message",[a,b,c,global_config])},this.registerSip=function(a){return global_config.standAlone=!1,webrtc_compliant()&&a!==!0?(loadUi(),this.requests.run("sip_register"),!0):(webrtcFacade.websock.close(),!1)},this.setAutoEraseThreshold=function(a){this.requests.run("set_auto_erase_threshold",[a])},this.acknowledgeMessage=function(a,b,c){this.requests.run("send_acknowledge",[a,b,c,global_config])},this.getPermanentMeetingPointByUid=function(a){this.requests.run("get_permanent_meeting_point_by_uid",[a])},this.test={onPluginMessageCallback:pluginFacade.callback,setConfig:function(a,b){global_config[a]=b},getConfig:function(a){return global_config[a]?global_config[a]:(debug("config not present"),!1)},set:function(a,b){globalVars[a]=b},get:function(a){return globalVars[a]?globalVars[a]:void debug("variable "+a+" not present")},inject:function(name,value){eval(name+" = value;")},eject:function(name){return eval(name)}},this.requestAgent=function(a){this.requests.run("request_agent",[a])},this.setOverlay=function(mode){this.requests.run("set_overlay",[mode])},this.requestAgentList=function(a){this.requests.run("request_agent_list",[a])},this.cancelAgentRequest=function(){this.requests.run("cancel_agent_request")},this.getWaitList=function(){this.requests.run("get_wait_list")},this.getConnectionMode=function(){return modeFacade&&modeFacade.getConnectionMode?modeFacade.getConnectionMode(""):void 0},this.reset=function(){debug("this function is depreciated, and no longer has any effect")},this.deleteMeetingPoint=function(a){return this.requests.run("delete_meeting_point",[a])};var currentMeetingPointDeletedId;this.updateWallSettings=function(a){this.requests.run("update_wall_settings",[a])},this.disconnect=function(){modeFacade.websock&&modeFacade.websock.close(),globalVars.state=Rtcc.STATES.SIP_NOK},this.getWallSettings=function(){this.requests.run("get_wall_settings")},this.destroy=function(){modeFacade.websock&&(modeFacade.websock.onmessage=function(){}),this.removeAllMessageEventListers(),this.disconnect(),globalVars.state=Rtcc.STATES.DESTROYED,globalVars.presence_state=Rtcc.PRESENCE_STATES.NOK,objectForEach(globalVars.timeout,function(a,b){clearTimeout(b)}),apiEvents.off(),apiEvents.offAll(),modeFacade.removePlugin&&modeFacade.removePlugin(),debug("Rtcc object destroyed.")};var apiEvents=new Vent;bindObjectToVent(this,apiEvents),this._extensionReadyListener=function(a){"CONNECT_JS_RTCC_OK"===a.data.type?vent.trigger("facade_proxy_opened"):"DISCONNECT_JS_RTCC"===a.data.type?vent.trigger("facade_proxy_closed"):"RTCC_PLUGIN_MISSING"===a.data.type&&vent.trigger("facade_proxy_plugin_missing")},this.removeAllMessageEventListers=function(){for(var a=0;a<globalVars.messageEventListeners.length;a++)window.removeEventListener("message",globalVars.messageEventListeners[a]);globalVars.messageEventListeners=[]},this.addMessageEventListener=function(a){var b=function(b){"TO_JS_RTCC"===b.data.type&&a(b.data.msg)};globalVars.messageEventListeners.push(b),window.addEventListener("message",b)}};window.Rtcc=Rtcc}(window),Rtcc.merge=function(){for(var a,b={},c=0,d=arguments.length;d>c;c++)for(a in arguments[c])arguments[c].hasOwnProperty(a)&&(b[a]=arguments[c][a]);return b},Rtcc._safelog=function(a){window.console&&window.console.log&&window.console.log(a)};var getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,webrtcMinimumVersion=null,webrtcUtils={log:function(a){"undefined"!=typeof module||"function"==typeof require&&"function"==typeof define||Rtcc._safelog(a)}};if("object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return"mozSrcObject"in this?this.mozSrcObject:this._srcObject},set:function(a){"mozSrcObject"in this?this.mozSrcObject=a:(this._srcObject=a,this.src=URL.createObjectURL(a))}}),getUserMedia=window.navigator&&window.navigator.getUserMedia),attachMediaStream=function(a,b){a.srcObject=b},reattachMediaStream=function(a,b){a.srcObject=b.srcObject},"undefined"!=typeof window&&window.navigator)if(navigator.mozGetUserMedia&&window.mozRTCPeerConnection){if(webrtcUtils.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),webrtcMinimumVersion=31,window.RTCPeerConnection=function(a,b){if(38>webrtcDetectedVersion&&a&&a.iceServers){for(var c=[],d=0;d<a.iceServers.length;d++){var e=a.iceServers[d];if(e.hasOwnProperty("urls"))for(var f=0;f<e.urls.length;f++){var g={url:e.urls[f]};0===e.urls[f].indexOf("turn")&&(g.username=e.username,g.credential=e.credential),c.push(g)}else c.push(a.iceServers[d])}a.iceServers=c}return new mozRTCPeerConnection(a,b)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,getUserMedia=function(a,b,c){var d=function(a){if("object"!=typeof a||a.require)return a;var b=[];return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d=a[c]="object"==typeof a[c]?a[c]:{ideal:a[c]};if((void 0!==d.min||void 0!==d.max||void 0!==d.exact)&&b.push(c),void 0!==d.exact&&("number"==typeof d.exact?d.min=d.max=d.exact:a[c]=d.exact,delete d.exact),void 0!==d.ideal){a.advanced=a.advanced||[];var e={};"number"==typeof d.ideal?e[c]={min:d.ideal,max:d.ideal}:e[c]=d.ideal,a.advanced.push(e),delete d.ideal,Object.keys(d).length||delete a[c]}}}),b.length&&(a.require=b),a};return 38>webrtcDetectedVersion&&(webrtcUtils.log("spec: "+JSON.stringify(a)),a.audio&&(a.audio=d(a.audio)),a.video&&(a.video=d(a.video)),webrtcUtils.log("ff37: "+JSON.stringify(a))),navigator.mozGetUserMedia(a,b,c)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(a){var b=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];a(b)})},41>webrtcDetectedVersion){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices()["catch"](function(a){if("NotFoundError"===a.name)return[];throw a})}}}else if(navigator.webkitGetUserMedia&&window.chrome){webrtcUtils.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),webrtcMinimumVersion=38,window.RTCPeerConnection=function(a,b){a&&a.iceTransportPolicy&&(a.iceTransports=a.iceTransportPolicy);var c=new webkitRTCPeerConnection(a,b),d=c.getStats.bind(c);return c.getStats=function(a,b,c){var e=this,f=arguments;if(arguments.length>0&&"function"==typeof a)return d(a,b);var g=function(a){var b={},c=a.result();return c.forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:a.type};a.names().forEach(function(b){c[b]=a.stat(b)}),b[c.id]=c}),b};if(arguments.length>=2){var h=function(a){f[1](g(a))};return d.apply(this,[h,arguments[0]])}return new Promise(function(b,c){1===f.length&&null===a?d.apply(e,[function(a){b.apply(null,[g(a)])},c]):d.apply(e,[b,c])})},c},["createOffer","createAnswer"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var c=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){b.apply(a,[d,e,c])})}return b.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=arguments,c=this;return new Promise(function(d,e){b.apply(c,[a[0],function(){d(),a.length>=2&&a[1].apply(null,[])},function(b){e(b),a.length>=3&&a[2].apply(null,[b])}])})}});var constraintsToChrome=function(a){if("object"!=typeof a||a.mandatory||a.optional)return a;var b={};return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d="object"==typeof a[c]?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);var e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];var f={};"number"==typeof d.ideal?(f[e("min",c)]=d.ideal,b.optional.push(f),f={},f[e("max",c)]=d.ideal,b.optional.push(f)):(f[e("",c)]=d.ideal,b.optional.push(f))}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(function(a){void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b};if(getUserMedia=function(a,b,c){return a.audio&&(a.audio=constraintsToChrome(a.audio)),a.video&&(a.video=constraintsToChrome(a.video)),webrtcUtils.log("chrome: "+JSON.stringify(a)),navigator.webkitGetUserMedia(a,b,c)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,enumerateDevices:function(){return new Promise(function(a){var b={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(c){a(c.map(function(a){return{label:a.label,kind:b[a.kind],deviceId:a.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(a){return webrtcUtils.log("spec:   "+JSON.stringify(a)),a.audio=constraintsToChrome(a.audio),a.video=constraintsToChrome(a.video),webrtcUtils.log("chrome: "+JSON.stringify(a)),origGetUserMedia(a)}}else navigator.mediaDevices.getUserMedia=function(a){return requestUserMedia(a)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){webrtcUtils.log("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){webrtcUtils.log("Dummy mediaDevices.removeEventListener called.")}),attachMediaStream=function(a,b){webrtcDetectedVersion>=43?a.srcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):webrtcUtils.log("Error attaching stream to element.")},reattachMediaStream=function(a,b){webrtcDetectedVersion>=43?a.srcObject=b.srcObject:a.src=b.src}}else navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?(webrtcUtils.log("This appears to be Edge"),webrtcDetectedBrowser="edge",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)[2],10),webrtcMinimumVersion=12):webrtcUtils.log("Browser does not appear to be WebRTC-capable");else webrtcUtils.log("This does not appear to be a browser"),webrtcDetectedBrowser="not a browser";var webrtcTesting={};if(Object.defineProperty(webrtcTesting,"version",{set:function(a){webrtcDetectedVersion=a}}),"undefined"!=typeof module){var RTCPeerConnection;"undefined"!=typeof window&&(RTCPeerConnection=window.RTCPeerConnection),module.exports={RTCPeerConnection:RTCPeerConnection,getUserMedia:getUserMedia,attachMediaStream:attachMediaStream,reattachMediaStream:reattachMediaStream,webrtcDetectedBrowser:webrtcDetectedBrowser,webrtcDetectedVersion:webrtcDetectedVersion,webrtcMinimumVersion:webrtcMinimumVersion,webrtcTesting:webrtcTesting}}else"function"==typeof require&&"function"==typeof define&&define([],function(){return{RTCPeerConnection:window.RTCPeerConnection,getUserMedia:getUserMedia,attachMediaStream:attachMediaStream,reattachMediaStream:reattachMediaStream,webrtcDetectedBrowser:webrtcDetectedBrowser,webrtcDetectedVersion:webrtcDetectedVersion,webrtcMinimumVersion:webrtcMinimumVersion,webrtcTesting:webrtcTesting}});!function(a){function b(a,b){return function(){a.apply(b,arguments)}}function c(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],i(a,b(e,this),b(f,this))}function d(a){var b=this;return null===this._state?void this._deferreds.push(a):void j(function(){var c=b._state?a.onFulfilled:a.onRejected;if(null===c)return void(b._state?a.resolve:a.reject)(b._value);var d;try{d=c(b._value)}catch(e){return void a.reject(e)}a.resolve(d)})}function e(a){try{if(a===this)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var c=a.then;if("function"==typeof c)return void i(b(c,a),b(e,this),b(f,this))}this._state=!0,this._value=a,g.call(this)}catch(d){f.call(this,d)}}function f(a){this._state=!1,this._value=a,g.call(this)}function g(){for(var a=0,b=this._deferreds.length;b>a;a++)d.call(this,this._deferreds[a]);this._deferreds=null}function h(a,b,c,d){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.resolve=c,this.reject=d}function i(a,b,c){var d=!1;try{a(function(a){d||(d=!0,b(a))},function(a){d||(d=!0,c(a))})}catch(e){if(d)return;d=!0,c(e)}}var j="function"==typeof setImmediate&&setImmediate||function(a){setTimeout(a,1)},k=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};c.prototype["catch"]=function(a){return this.then(null,a)},c.prototype.then=function(a,b){var e=this;return new c(function(c,f){d.call(e,new h(a,b,c,f))})},c.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&k(arguments[0])?arguments[0]:arguments);return new c(function(b,c){function d(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){d(f,a)},c)}a[f]=g,0===--e&&b(a)}catch(i){c(i)}}if(0===a.length)return b([]);for(var e=a.length,f=0;f<a.length;f++)d(f,a[f])})},c.resolve=function(a){return a&&"object"==typeof a&&a.constructor===c?a:new c(function(b){b(a)})},c.reject=function(a){return new c(function(b,c){c(a)})},c.race=function(a){return new c(function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,c)})},c._setImmediateFn=function(a){j=a},"undefined"!=typeof module&&module.exports?module.exports=c:a.Promise||(a.Promise=c)}(this),Rtcc.pickupMode={VIDEO:"video",NOVIDEO:"novideo",HIDDEN:"hidden"},Rtcc.annotationMode={POINTER:"pointer",DRAW:"draw",DROP:"drop"},Rtcc.pluginMode={EMBEDDED:"embedded",STANDALONE:"standalone"},Rtcc.meetingPointType={PERMANENT:"permanent",SCHEDULED:"scheduled",ADHOC:"adhoc",HOSTLESS:"hostless"},Rtcc.videoboxSize={THUMB:"thumb",WIDE:"wide",FULLSCREEN:"fullscreen"},Object.defineProperties?Object.defineProperties(Rtcc,{videoboxStartupSize:{get:function(){return Rtcc._safelog("WARNING: videoboxStartupSize is depreciated, please use videoboxSize instead"),Rtcc.videoboxSize}}}):Rtcc.videoboxStartupSize=Rtcc.videoboxSize,Rtcc.callType={ONE_TO_ONE:"1",N_TO_N:"n"},Rtcc.overlay={ON:"1",OFF:"0"},Rtcc.meetingPointMode={LOCKED:"locked",AUTO_ACCEPT:"auto-accept",DEFAULT:"default"},Object.defineProperties?Object.defineProperties(Rtcc,{meetingPointModes:{get:function(){return Rtcc._safelog('WARNING: meetingPointModes is depreciated, please use meetingPointMode instead (with no "s").'),Rtcc.meetingPointMode}}}):Rtcc.meetingPointModes=Rtcc.meetingPointMode,Rtcc.toastType={INFO:"info",MESSAGE:"message",WARNING:"warning"},Rtcc.videoProfile={THUMBNAIL:"ld",SMALL:"sd",MEDIUM:"md",MEDIUM_HIGH:"mhd",HIGH:"hd"},Rtcc.postMessage=function(a){window.postMessage({type:"FROM_JS_RTCC",msg:a},"*")},Rtcc.PRESENCE_STATES={NOK:-1,OK:1},Rtcc.connectionModes={EXTENTION:"extension",PLUGIN:"plugin",WEBRTC:"webrtc"},Rtcc.STATES={DESTROYED:-1,NOT_CONNECTED_TO_FACADE:0,AUDIO_NOK:1,SIP_NOK:2,VERIFIED_USER_NOK:3,CONNECTED_TO_FACADE:4,VERIFIED_USER_OK:5,SIP_OK:6};var sightcallPluginLoaded;